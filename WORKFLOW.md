# Workflow

## CLI Entry Point

*   `main`: Entry point handling argument parsing and dispatching high-level commands.
    *   `build_parser`: Constructs the argument parser with supported flags and options.
    *   `parse_args`: Parses command-line arguments into a namespace.
    *   `run_upgrade`: Upgrades the tool via `uv` if requested.
    *   `run_uninstall`: Uninstalls the tool via `uv` if requested.
    *   `maybe_print_version`: Prints the current package version if requested.
    *   `run`: Orchestrates the main execution flow (install, update, or remove).

## Removal Workflow

*   `run` (when --remove is set)
    *   `run_remove`: Manages the cleanup of generated resources.
        *   `maybe_notify_newer_version`: Checks online for a newer version of the package.
        *   `remove_generated_resources`: Deletes configuration files and directories generated by the tool.
            *   `ensure_wrapped`: Verifies that the target path is safe (under the project root).
        *   `prune_empty_dirs`: Recursively removes empty directories in target locations.

## Initialization & Update Workflow

*   `run` (Installation/Update)
    *   **Configuration & Validation**
        *   `load_config`: Loads existing configuration from `.req/config.json` during updates.
        *   `ensure_doc_directory`: Verifies that the documentation directory exists and is valid.
        *   `make_relative_if_contains_project`: Normalizes paths to be relative to the project root.
        *   `ensure_relative`: Raises an error if a path is absolute.
        *   `resolve_absolute`: Resolves a normalized path to an absolute path.
        *   `maybe_notify_newer_version`: Checks for package updates before proceeding.
        *   `save_config`: Saves current parameters to `.req/config.json`.
        *   Copies `models.json` or `models-legacy.json` from package resources to `.req/models.json` after creating the `.req` directory. When `--legacy` is active and `models-legacy.json` exists, copies it instead of `models.json`. When `--preserve-models` is active, skips overwriting `.req/models.json` to preserve custom configurations.
    *   **Environment Preparation**
        *   `compute_sub_path`: Calculates relative paths for token substitution.
        *   `make_relative_token`: Formats paths as tokens for templates.
        *   `find_template_source`: Locates the source directory for templates.
        *   `copy_tech_templates`: Copies technical templates from `src/usereq/resources/tech/` to the target directory specified by `--dir`. The function accepts an `overwrite` parameter that controls whether existing files are preserved (`False` for `--write-tech`) or overwritten (`True` for `--overwrite-tech`). Executed only when `--write-tech` or `--overwrite-tech` flags are active, before generating directory lists.
        *   `generate_doc_file_list`: Creates a list of documentation files for `%%REQ_DOC%%`.
        *   `generate_dir_list`: Creates a list of technical directories for `%%REQ_DIR%%`.
    *   **Resource Generation**
        *   `load_kiro_template`: Loads Kiro agent templates from centralized models configuration.
        *   `load_centralized_models`: Loads configurations for external CLIs (Claude, Copilot, Kiro, etc.) from centralized `common/models.json` or `common/models-legacy.json` when `--legacy` flag is active. When `--preserve-models` is active with `--update` and `.req/models.json` exists, loads from that file instead, bypassing `--legacy`.
        *   **Prompt Processing Loop** (Iterates over available prompts)
            *   `extract_frontmatter`: Separates metadata from the prompt body.
            *   `extract_description`: Retrieves the description from frontmatter.
            *   `apply_replacements`: Substitutes tokens in text with calculated values.
            *   `write_text_file`: Writes generated content to the destination file.
            *   **New `recreate` prompt**: Introduces the reorganizing-and-renumbering workflow along with the same provider metadata as `create`, so artifact generation for enabled providers now includes `recreate` content as well.
            *   **Format-Specific Generators**
                *   `md_to_toml`: Converts Markdown prompts to TOML format for Gemini.
                *   `replace_tokens`: Updates TOML files with dynamic values.
                *   `get_model_tools_for_prompt`: Retrieves model and tool settings for a specific prompt.
                *   `format_tools_inline_list`: Formats tool lists for configuration files.
                *   `generate_kiro_resources`: Lists file resources required by Kiro agents.
                *   `render_kiro_agent`: Renders the final JSON configuration for Kiro agents.
                *   `yaml_double_quote_escape`: Escapes strings for YAML compatibility.
    *   **Settings & Templates**
        *   `find_vscode_settings_source`: Locates the VS Code settings template.
        *   `load_settings`: Parses JSON settings files, stripping comments if needed.
        *   `strip_json_comments`: Removes C-style comments from JSON content.
        *   `deep_merge_dict`: Recursively merges new settings into the existing configuration.
        *   `build_prompt_recommendations`: Creates VS Code prompt recommendations.
        *   `save_vscode_backup`: Creates a backup of existing VS Code settings.
        *   `write_text_file`: Writes the final merged settings to `.vscode/settings.json`.
        *   **Final Reporting**
            *   `collect_modules_installed`: Gathers which CLI targets installed modules by checking generated folders.
            *   `collect_prompts_installed`: Records the list of prompt names generated for each target so the report lists them.
            *   `print_installation_summary`: Prints the ASCII table that now includes `Prompts Installed` between `CLI` and `Modules Installed` along with workflow installation flags.

## Documentation Utilities

*   `generate_pdoc_docs`: Main function to generate HTML documentation using pdoc.
    *   `_normalize_modules`: Standardizes input module names into a list.
    *   `_run_pdoc`: Executes the pdoc process in a subprocess.


