---
title: "useReq Requirements"
description: "Software Requirements Specification"
date: "2026-02-19"
version: 1.02
author: "Ogekuri"
scope:
  paths:
    - "**/*.py"
  excludes:
    - ".*/**"
visibility: "draft"
tags: ["markdown", "requirements", "srs"]
---

# useReq Requirements

## 1. Introduction
useReq is a text-based CLI that initializes and updates repository resources for multi-agent workflows and source-analysis commands.

### 1.1 Document Rules
- This document MUST be written and maintained in English.
- RFC 2119 keywords MUST be used exclusively: MUST, MUST NOT, SHOULD, SHOULD NOT, MAY.
- Each requirement MUST be atomic, single-sentence, and testable; target <= 35 words per requirement; split compound behavior into separate requirement IDs.
- Requirement bullets in requirements sections MUST start with a unique, stable requirement ID and MUST preserve all pre-existing ID values.
- Pre-existing requirement IDs MUST NOT be renumbered, renamed, or reused; newly created requirement IDs MUST be appended beyond the current highest ID.
- This document MUST NOT introduce requirements about source-code comment authoring style beyond already preserved requirements.

### 1.2 Project Scope
- Primary interface: CLI (`req`, `use-req`, `usereq`).
- Functional domains: project resource generation, configuration persistence, source analysis, token counting, compression, construct extraction, and Doxygen field extraction.
- Out-of-scope for this SRS rewrite: source-code modification.

### 1.3 Components and Dependencies
- Runtime: Python 3.11+.
- Core libraries: `argparse`, `pathlib`, `json`, `re`, `os`, `shutil`, `urllib`.
- Tokenization: `tiktoken` (`cl100k_base` default).
- Workflow automation: `.github/workflows/release-uvx.yml`.

### 1.4 Project Structure (evidence tree)
```text
.
├── docs/
│   ├── REQUIREMENTS.md
│   ├── REFERENCES.md
│   └── WORKFLOW.md
├── .github/workflows/
│   └── release-uvx.yml
├── src/usereq/
│   ├── __init__.py
│   ├── __main__.py
│   ├── cli.py
│   ├── source_analyzer.py
│   ├── generate_markdown.py
│   ├── compress.py
│   ├── compress_files.py
│   ├── find_constructs.py
│   ├── doxygen_parser.py
│   ├── token_counter.py
│   └── resources/
│       ├── common/
│       ├── docs/
│       ├── prompts/
│       └── vscode/
└── tests/
    ├── fixtures/
    └── test_*.py
```

### 1.5 User Interface and Behavioral Overview
- Implemented UI is CLI-only; no GUI behavior is implemented.
- Output channels: stdout for normal payloads and stderr for warnings/errors/verbose status.
- Configuration persistence: `.req/config.json` and `.req/models.json`.

### 1.6 Performance Evidence
No explicit performance optimizations identified.

## 2. Project Requirements

### 2.1 Project Functions
- **SRS-001**: The implementation MUST preserve this behavior exactly: Il comando deve inizializzare un progetto creando o aggiornando documenti di requisiti, template tecnici e risorse di prompt basati sulla root indicata dall'utente.
- **SRS-002**: The implementation MUST preserve this behavior exactly: Il comando deve accettare esattamente una delle opzioni `--base` o `--here`. Con `--base` deve usare i parametri espliciti `--guidelines-dir`, `--docs-dir`, `--tests-dir`, e `--src-dir`; con `--here` deve usare esclusivamente i valori `guidelines-dir`, `docs-dir`, `tests-dir`, e `src-dir` estratti da `.req/config.json`, ignorando eventuali path passati con i parametri espliciti.
- **SRS-003**: The implementation MUST preserve this behavior exactly: Il comando deve generare risorse di prompt per Codex, GitHub e Gemini sostituendo i token di percorso con valori relativi calcolati.
- **SRS-004**: The implementation MUST preserve this behavior exactly: Il comando deve aggiornare i template locali in `.req/docs` e integrare le impostazioni di VS Code quando disponibili.
- **SRS-005**: The implementation MUST preserve this behavior exactly: L'interfaccia utente deve essere una CLI testuale con messaggi di errore e log di progresso opzionali.

### 2.2 Project Constraints
- **SRS-006**: The implementation MUST preserve this behavior exactly: I valori di `--guidelines-dir`, `--docs-dir`, `--tests-dir`, e `--src-dir` possono essere percorsi assoluti o relativi quando si usa `--base`. I percorsi devono essere normalizzati rispetto alla root del progetto passata con `--base` verificando se presente nei percorsi passati con `--guidelines-dir`, `--docs-dir`, `--tests-dir`, e `--src-dir`. Quando si usa `--here`, i percorsi espliciti devono essere ignorati e i percorsi effettivi devono essere caricati da `.req/config.json`.
- **SRS-007**: The implementation MUST preserve this behavior exactly: La directory requisiti del progetto deve coincidere con il percorso `--docs-dir` normalizzato sotto la root del progetto e non deve essere configurabile con un parametro dedicato.
- **SRS-008**: The implementation MUST preserve this behavior exactly: Il percorso passato a `--guidelines-dir` e poi normalizzato rispetto a `--base`, deve esistere come directory reale sotto la root del progetto prima della copia delle risorse.
- **SRS-009**: The implementation MUST preserve this behavior exactly: Il percorso passato a `--docs-dir` e poi normalizzato rispetto a `--base`, deve esistere come directory reale sotto la root del progetto prima della copia delle risorse.
- **SRS-010**: The implementation MUST preserve this behavior exactly: Il percorso passato a `--tests-dir` e poi normalizzato rispetto a `--base`, deve esistere come directory reale sotto la root del progetto prima della copia delle risorse.
- **SRS-011**: The implementation MUST preserve this behavior exactly: Il percorso passato a `--src-dir` e poi normalizzato rispetto a `--base`, deve esistere come directory reale sotto la root del progetto prima della copia delle risorse.
- **SRS-012**: The implementation MUST preserve this behavior exactly: La rimozione di directory preesistenti `.req` o `.req/docs` deve essere permessa solo se tali percorsi sono sotto la root del progetto.
- **SRS-013**: The implementation MUST preserve this behavior exactly: Il comando deve fallire se il progetto specificato non esiste sul filesystem.

## 3. Requirements

### 3.1 Design and Implementation Constraints
- **SRS-014**: The implementation MUST preserve this behavior exactly: Il calcolo del token `%%GUIDELINES_FILES%%` deve essere sostituito con la lista di directory trovate nella cartella specificata con `--guidelines-dir`. Quando espanso inline, la lista deve essere formattata usando notazione inline code (backticks) per ogni elemento nella forma `dir1/`, `dir2/` (con slash finale).
- **SRS-015**: The implementation MUST preserve this behavior exactly: La sorgente del template `Requirements_Template.md` deve essere la cartella `resources/docs` inclusa nel pacchetto e il comando deve fallire se il template non è disponibile.
- **SRS-016**: The implementation MUST preserve this behavior exactly: La conversione di prompt Markdown in TOML deve estrarre il campo `description` dal front matter e salvare il corpo del prompt in una stringa multilinea.
- **SRS-017**: The implementation MUST preserve this behavior exactly: L'unione delle impostazioni VS Code deve supportare file JSONC rimuovendo i commenti e deve unire ricorsivamente gli oggetti con priorità ai valori del template.
- **SRS-018**: The implementation MUST preserve this behavior exactly: Le raccomandazioni `chat.promptFilesRecommendations` devono essere generate partendo dai prompt Markdown disponibili.
- **SRS-019**: The implementation MUST preserve this behavior exactly: L'entry point del pacchetto deve esporre `usereq.cli:main` via `use-req`, `req`, e `usereq`.
- **SRS-020**: The implementation MUST preserve this behavior exactly: Gli errori attesi devono essere gestiti via eccezione dedicata con exit code non-zero.
- **SRS-021**: The implementation MUST preserve this behavior exactly: La funzione `load_cli_configs` deve essere sostituita con `load_centralized_models` che carica i dati dal file `src/usereq/resources/common/models.json`. Quando `legacy_mode` è attivo, deve caricare `models-legacy.json` se esiste, altrimenti fare fallback su `models.json`. Il fallback deve avvenire a livello di file completo, non per singole voci. La struttura di ritorno deve rimanere compatibile: un dizionario `cli_name -> config` dove `config` contiene le chiavi `prompts`, `usage_modes`, e opzionalmente `agent_template`.
- **SRS-022**: The implementation MUST preserve this behavior exactly: La funzione `generate_req_file_list` non deve essere utilizzata dal flusso di generazione prompt e il token `%%REQ_DIR%%` non deve essere più supportato.
- **SRS-023**: The implementation MUST preserve this behavior exactly: La funzione `generate_dir_list` deve essere rinominata in `generate_guidelines_file_list`. Il comportamento deve essere allineato a `generate_req_file_list`: scansionare la directory specificata (quella passata con `--guidelines-dir`) e restituire la lista dei file presenti in quella directory (senza ricerca ricorsiva di sottocartelle), ignorando i file che iniziano con punto (`.`). Se la directory è vuota o non contiene file non nascosti, deve restituire il nome della directory stessa come fallback (preservando il comportamento originale solo per il caso di directory vuota).
- **SRS-024**: The implementation MUST preserve this behavior exactly: All source code files within `src/` must include comprehensive Doxygen-style documentation for modules, classes, functions, and methods.
- **SRS-025**: The implementation MUST preserve this behavior exactly: The documentation format must strictly follow the guidelines provided in `guidelines/Document_Source_Code_in_Doxygen_Style_for_LLM-Agent.md`, focusing on semantic density for LLM consumption.
- **SRS-026**: The implementation MUST preserve this behavior exactly: Documentation blocks must use standard language-specific docstring syntax (e.g., triple double quotes `"""` for Python) and include standard Doxygen tags (e.g., `@param`, `@return`, `@brief`) as specified in the guidelines.

### 3.2 CLI Interface and Lifecycle
- **SRS-027**: The no-argument invocation behavior MUST be treated as legacy intent; current true-state behavior prints parser help and returns success without an additional standalone version line (see `SRS-028`).
- **SRS-028**: The CLI with no arguments MUST print parser help and exit with code 0, and the current implementation does not append a standalone version line in this path.
- **SRS-029**: The implementation MUST preserve this behavior exactly: Quando il comando `req` è invocato con l'opzione `--ver` o `--version`, l'output deve contenere solo il numero versione.
- **SRS-030**: The implementation MUST preserve this behavior exactly: The help usage string MUST include command `req`, version, and all available options including `--legacy`, `--add-guidelines`, `--upgrade-guidelines`, `--files-tokens`, `--files-references`, `--files-compress`, `--files-find`, `--references`, `--compress`, `--find`, `--enable-line-numbers`, `--tokens`, `--enable-prompts`, `--enable-agents`, and `--disable-skills` in `usage: req -c ...` format. When `req` is invoked without parameters, the `--files-find` help text MUST include the dynamic list of available TAGs by language generated from `LANGUAGE_TAGS`. The `--find` help text MUST explicitly reference the list shown in `--files-find` to avoid duplication.
- **SRS-031**: The implementation MUST preserve this behavior exactly: All usage, help, information, verbose, and debug outputs emitted by the script MUST be in English.
- **SRS-032**: The implementation MUST preserve this behavior exactly: Il comando deve richiedere i parametri `--docs-dir`, `--tests-dir`, e `--src-dir` e verificare che indichino directory esistenti quando è usato `--base`; quando è usato `--here` deve caricare tali percorsi da `.req/config.json` e ignorare eventuali valori passati con i parametri espliciti.
- **SRS-033**: The implementation MUST preserve this behavior exactly: Il parametro `--src-dir` deve poter essere fornito più volte; ogni directory passata deve essere normalizzata come gli altri percorsi e deve esistere, altrimenti il comando deve terminare con errore.
- **SRS-034**: The CLI MUST accept boolean flags `--enable-claude`, `--enable-codex`, `--enable-gemini`, `--enable-github`, `--enable-kiro`, `--enable-opencode`, `--enable-prompts`, `--enable-agents`, `--disable-skills`, `--legacy`, and `--preserve-models`. Default state MUST be: `--enable-prompts=false`, `--enable-agents=false`, `--disable-skills=false`. When a provider `--enable-<provider>` flag is omitted, the CLI MUST skip all resource creation for that provider. When `--enable-prompts` is active, prompt/command artifact files MUST be generated for each enabled provider that produces them. When `--enable-agents` is active, agent artifact files MUST be generated for each enabled provider that produces them. When `--disable-skills` is not active, skill artifact files MUST be generated for each enabled provider that produces them. When `--legacy` is active, the CLI MUST activate legacy mode for configuration loading. When `--preserve-models` is active in combination with `--update`, the CLI MUST preserve the existing `.req/models.json` file and the `--legacy` flag has no effect.
- **SRS-035**: During installation without `--update`, the CLI MUST require at least one enabled provider and at least one active artifact type among prompts, agents, or skills; otherwise it MUST print an English error and exit code 4.
- **SRS-036**: The implementation MUST preserve this behavior exactly: La tabella riassuntiva di installazione ASCII deve includere righe solo per i target CLI i cui prompt sono stati installati durante l'invocazione corrente.
- **SRS-037**: The implementation MUST preserve this behavior exactly: Il comando deve supportare i flag booleani `--add-guidelines` e `--upgrade-guidelines` (default false). Questi flag attivano la copia dei contenuti della directory `src/usereq/resources/guidelines/` nella directory specificata da `--guidelines-dir`. L'operazione di copia deve essere eseguita prima della chiamata a `generate_guidelines_file_list`. Se la directory sorgente esiste ma non contiene file non nascosti, il comando deve completare senza errore e considerare la copia come operazione valida con zero file copiati.
- **SRS-038**: The implementation MUST preserve this behavior exactly: Quando `--add-guidelines` è attivo, il comando deve copiare tutti i file non nascosti presenti in `src/usereq/resources/guidelines/` nella directory target specificata da `--guidelines-dir`, preservando i file esistenti (senza sovrascriverli) se hanno lo stesso nome.
- **SRS-039**: The implementation MUST preserve this behavior exactly: Quando `--upgrade-guidelines` è attivo, il comando deve copiare tutti i file non nascosti presenti in `src/usereq/resources/guidelines/` nella directory target specificata da `--guidelines-dir`, sovrascrivendo i file esistenti se hanno lo stesso nome.
- **SRS-040**: The implementation MUST preserve this behavior exactly: I flag `--add-guidelines` e `--upgrade-guidelines` sono mutualmente esclusivi: se entrambi sono forniti contemporaneamente, il comando deve terminare con errore.
- **SRS-041**: The implementation MUST preserve this behavior exactly: La copia dei template tecnici deve avvenire solo quando almeno uno dei due flag (`--add-guidelines` o `--upgrade-guidelines`) è attivo. Se nessuno dei due flag è fornito, l'operazione di copia non deve essere eseguita.
- **SRS-042**: `--uninstall` and `--upgrade` dispatch MUST execute before argparse parsing and before regular initialization flow; `--uninstall` has precedence when both flags are present in argv order handling.
- **SRS-043**: The implementation MUST preserve this behavior exactly: L'opzione `--upgrade` deve eseguire il comando `uv tool install usereq --force --from git+https://github.com/Ogekuri/useReq.git` e terminare con errore se fallisce.
- **SRS-044**: The implementation MUST preserve this behavior exactly: La stringa di aiuto deve includere `--upgrade` come opzione disponibile.
- **SRS-045**: The implementation MUST preserve this behavior exactly: L'opzione `--uninstall` deve eseguire `uv tool uninstall usereq` e terminare con errore se fallisce.
- **SRS-046**: The implementation MUST preserve this behavior exactly: La stringa di aiuto deve includere `--uninstall` come opzione disponibile.
- **SRS-047**: The implementation MUST preserve this behavior exactly: After successful installation or update, the CLI MUST print a single English line reporting success and including the resolved project root path.
- **SRS-048**: The implementation MUST preserve this behavior exactly: Immediatamente dopo il messaggio di successo, la CLI deve stampare una lista delle directory scoperte per la sostituzione del token `%%GUIDELINES_FILES%%`, prefissate da `- `.
- **SRS-049**: The implementation MUST preserve this behavior exactly: Immediatamente dopo la lista file, la CLI deve stampare una tabella leggibile ASCII descrivendo quali prompt e moduli sono stati installati per ogni target CLI.
- **SRS-050**: The implementation MUST preserve this behavior exactly: Il comando, dopo validazione input e prima di modifiche filesystem, deve verificare disponibilità online di nuova versione tramite chiamata HTTP GET a GitHub API con timeout 1 secondo.
- **SRS-051**: The online release-check path MUST be fail-open: network errors, HTTP errors, timeout errors, JSON parse errors, and invalid payload values are swallowed and MUST NOT abort command execution.
- **SRS-052**: The implementation MUST preserve this behavior exactly: If the release-check call succeeds and the remote version is greater than `__version__`, the command MUST print an English message showing current version, latest version, and upgrade command.
- **SRS-053**: The implementation MUST preserve this behavior exactly: Se la directory indicata da `--docs-dir` è vuota, il comando deve generare un file `requirements.md` usando il template `Requirements_Template.md` dalla cartella `resources/docs`.
- **SRS-054**: The implementation MUST preserve this behavior exactly: Il progetto deve includere uno script `req.sh` nella root repository per avviare la versione in sviluppo.
- **SRS-055**: The implementation MUST preserve this behavior exactly: Lo script `req.sh` deve essere eseguibile da qualsiasi percorso, risolvere la propria directory, verificare `.venv` e crearlo se assente.
- **SRS-056**: The implementation MUST preserve this behavior exactly: Se `.venv` esiste, `req.sh` deve eseguire il comando usando il Python del venv inoltrando gli argomenti.
- **SRS-057**: The implementation MUST preserve this behavior exactly: Il progetto deve includere uno script `doxygen.sh` nella root repository per generare documentazione Doxygen dai sorgenti presenti in `src/`.
- **SRS-058**: The implementation MUST preserve this behavior exactly: Lo script `doxygen.sh` deve risolvere la root del repository dal proprio percorso, usare l'eseguibile `doxygen` installato nel sistema operativo, e generare output nei path `doxygen/html`, `doxygen/pdf`, `doxygen/markdown`.
- **SRS-059**: The implementation MUST preserve this behavior exactly: La configurazione Doxygen usata da `doxygen.sh` deve applicare opzioni best-practice per documentazione completa del codice in `src/`, includendo estrazione membri pubblici/privati/statici e ricorsione input; per il formato Markdown lo script deve usare `GENERATE_MARKDOWN` quando supportato dalla versione Doxygen installata, altrimenti deve produrre `doxygen/markdown` tramite trasformazione deterministica dei metadati XML generati da Doxygen.
- **SRS-060**: The implementation MUST preserve this behavior exactly: Il comando deve salvare i valori di `--guidelines-dir`, `--docs-dir`, `--tests-dir`, e l'elenco di `--src-dir` in `.req/config.json` come percorsi relativi.
- **SRS-061**: The implementation MUST preserve this behavior exactly: Il file `.req/config.json` deve includere campi `guidelines-dir`, `docs-dir`, `tests-dir`, e `src-dir` preservando slash finali; `src-dir` deve essere un array con una voce per ogni directory passata.
- **SRS-062**: The implementation MUST preserve this behavior exactly: Il comando deve supportare l'opzione `--update` per rieseguire l'inizializzazione usando parametri salvati.
- **SRS-063**: The implementation MUST preserve this behavior exactly: Quando `--update` è presente, il comando deve verificare presenza di `.req/config.json` e terminare con errore se assente.
- **SRS-064**: With `--update`, the CLI MUST load paths and persisted boolean flags from `.req/config.json`, then apply only CLI-provided flags as overrides; if provider/artifact activation is invalid, it MUST raise a config-invalid error.
- **SRS-065**: The implementation MUST preserve this behavior exactly: Il comando deve copiare in `.req/docs` tutti i file presenti in `src/usereq/resources/docs/`, generando dinamicamente a runtime la lista dei file da copiare, e deve rimpiazzare i file pre-esistenti.
- **SRS-066**: The implementation MUST preserve this behavior exactly: Il comando deve copiare il file di configurazione modelli in `.req/models.json`, rimpiazzando il file pre-esistente se presente, a meno che `--preserve-models` sia attivo. Quando `--preserve-models` NON è attivo: se `--legacy` NON è attivo, deve copiare `models.json` dalle risorse del pacchetto (`src/usereq/resources/common/models.json`); se `--legacy` è attivo E il file `models-legacy.json` è caricato con successo (cioè quando esiste), deve copiare `models-legacy.json` dalle risorse del pacchetto (`src/usereq/resources/common/models-legacy.json`); se `--legacy` è attivo ma `models-legacy.json` non esiste, deve copiare `models.json`. Questa copia deve avvenire dopo la creazione della directory `.req` e dopo il salvataggio di `config.json`.
- **SRS-067**: The implementation MUST preserve this behavior exactly: Se il template VS Code è disponibile, deve creare o aggiornare `.vscode/settings.json` unendo impostazioni.
- **SRS-068**: The implementation MUST preserve this behavior exactly: Prima di modificare `.vscode/settings.json`, deve salvare lo stato originale in backup sotto `.req/` (per ripristino con remove).
- **SRS-069**: The implementation MUST preserve this behavior exactly: L'aggiornamento di `.vscode/settings.json` deve avvenire solo se ci sono differenze semantiche; se non ce ne sono, non deve riscrivere né creare backup.
- **SRS-070**: The implementation MUST preserve this behavior exactly: Il file `.req/settings.json.absent` non deve mai essere generato.
- **SRS-071**: The implementation MUST preserve this behavior exactly: Il comando non deve generare né sostituire i token `%%REQ_DIR%%` e `%%REQ_PATH%%` nei prompt.
- **SRS-072**: The implementation MUST preserve this behavior exactly: I template prompt devono essere trattati senza parsing o rendering di placeholder relativi ai requisiti (`%%REQ_*%%`).
- **SRS-073**: The implementation MUST preserve this behavior exactly: Lo script deve relativizzare percorsi che contengono il path home progetto.
- **SRS-074**: The implementation MUST preserve this behavior exactly: Il comando deve sostituire `%%GUIDELINES_FILES%%` con la lista di sottocartelle in `--guidelines-dir` formattate come inline code con slash finale.
- **SRS-075**: The implementation MUST preserve this behavior exactly: Se la directory `--guidelines-dir` è vuota, usare la directory stessa per `%%GUIDELINES_FILES%%`.
- **SRS-076**: The implementation MUST preserve this behavior exactly: La lista directory per `%%GUIDELINES_FILES%%` deve usare percorsi relativi.
- **SRS-077**: The implementation MUST preserve this behavior exactly: Il comando deve sostituire `%%GUIDELINES_PATH%%` con il percorso passato con `--guidelines-dir`, normalizzato rispetto alla root del progetto.
- **SRS-078**: The implementation MUST preserve this behavior exactly: Il comando deve sostituire `%%DOC_PATH%%` con il percorso passato con `--docs-dir`, normalizzato rispetto alla root del progetto.
- **SRS-079**: The implementation MUST preserve this behavior exactly: Il comando deve sostituire `%%TEST_PATH%%` con il percorso passato con `--tests-dir`, normalizzato rispetto alla root del progetto, formattato come inline code (backticks) e aggiungendo sempre una slash finale anche quando il valore passato non la include.
- **SRS-080**: The implementation MUST preserve this behavior exactly: Il comando deve sostituire `%%SRC_PATHS%%` con l'elenco delle directory passate con `--src-dir`, normalizzate rispetto alla root del progetto, formattate come inline code con slash finale, e separate da `, `.
- **SRS-081**: The implementation MUST preserve this behavior exactly: Il comando deve supportare opzioni `--enable-models` e `--enable-tools` per includere campi `model` e `tools` nei file generati.
- **SRS-082**: The implementation MUST preserve this behavior exactly: Con `--enable-models`, includere `model: <valore>` se presente in `config.json` della risorsa.
- **SRS-083**: The implementation MUST preserve this behavior exactly: Con `--enable-tools`, includere `tools` derivato da `usage_modes` se presente in `config.json`.
- **SRS-084**: The implementation MUST preserve this behavior exactly: L'inclusione di `model` e `tools` è condizionale alla validità del file di configurazione centralizzato (`models.json` o `models-legacy.json` a seconda della modalità legacy).
- **SRS-085**: The implementation MUST preserve this behavior exactly: La CLI deve caricare le configurazioni per la generazione dei prompt. Quando `--preserve-models` è attivo in combinazione con `--update` e il file `.req/models.json` esiste, deve caricare le configurazioni da `.req/models.json`; in questo caso il flag `--legacy` non ha effetto. Quando `--preserve-models` NON è attivo o il file `.req/models.json` non esiste: deve caricare dal file centralizzato `src/usereq/resources/common/models.json`, leggendo la voce corrispondente al CLI (`<cli>`) per ottenere `prompts` e `usage_modes`; se il flag `--legacy` è attivo, la CLI deve prima verificare la presenza del file `src/usereq/resources/common/models-legacy.json`; se esiste, deve caricarlo al posto di `models.json` (fallback a livello di file, non di singole voci); se `models-legacy.json` non esiste, deve usare `models.json`. I file `src/usereq/resources/<cli>/config.json` non devono più essere utilizzati e possono essere rimossi dal disco.
- **SRS-086**: The implementation MUST preserve this behavior exactly: La stringa di aiuto deve includere `--legacy` e `--preserve-models` come opzioni disponibili.

### 3.3 Provider Resource Generation
- **SRS-087**: The implementation MUST preserve this behavior exactly: La generazione risorse descritta nelle sezioni specifiche deve eseguire solo quando il flag `--enable-<provider>` corrispondente è attivo.
- **SRS-088**: The implementation MUST preserve this behavior exactly: Il prompt `recreate` deve essere aggiunto a `src/usereq/resources/prompts` e trattato come prompt standard. Deve essere generato per ogni provider abilitato.
- **SRS-089**: The CLI MUST create provider artifact directories only when the corresponding provider flag AND the corresponding artifact-type activation are both active: `.codex/prompts` when `--enable-codex` AND `--enable-prompts`; `.codex/skills` when `--enable-codex` AND skills are active (`--disable-skills` absent); `.github/agents` when `--enable-github` AND `--enable-agents`; `.github/prompts` when `--enable-github` AND `--enable-prompts`; `.github/skills` when `--enable-github` AND skills are active (`--disable-skills` absent); `.gemini/commands` and `.gemini/commands/req` when `--enable-gemini` AND `--enable-prompts`; `.gemini/skills` when `--enable-gemini` AND skills are active (`--disable-skills` absent); `.kiro/agents` when `--enable-kiro` AND `--enable-agents`; `.kiro/prompts` when `--enable-kiro` AND `--enable-prompts`; `.kiro/skills` when `--enable-kiro` AND skills are active (`--disable-skills` absent); `.claude/agents` when `--enable-claude` AND `--enable-agents`; `.claude/commands` and `.claude/commands/req` when `--enable-claude` AND `--enable-prompts`; `.claude/skills` when `--enable-claude` AND skills are active (`--disable-skills` absent); `.opencode/agent` when `--enable-opencode` AND `--enable-agents`; `.opencode/command` when `--enable-opencode` AND `--enable-prompts`; `.opencode/skill` when `--enable-opencode` AND skills are active (`--disable-skills` absent).
- **SRS-090**: For each Markdown prompt, the CLI MUST copy to `.codex/prompts/req.<name>.md` with token substitutions when BOTH `--enable-codex` AND `--enable-prompts` are active.
- **SRS-091**: For each Markdown prompt, the CLI MUST create `.github/prompts/req.<name>.prompt.md` when BOTH `--enable-github` AND `--enable-prompts` are active.
- **SRS-092**: The `.github/prompts` front matter MUST reference the agent (only `agent: req-<name>`) when `--prompts-use-agents` is enabled AND BOTH `--enable-github` AND `--enable-prompts` are active; otherwise the full prompt body with metadata MUST be emitted.
- **SRS-093**: For each Markdown prompt, the CLI MUST generate `.github/agents/req.<name>.agent.md` with front matter including `name` when BOTH `--enable-github` AND `--enable-agents` are active.
- **SRS-094**: For each enabled provider with active skills (default active; disabled only by `--disable-skills`), the CLI MUST create a `skills` directory under the provider root (or `skill` for OpenCode) and, for each Markdown prompt, the subdirectory `<skills_root>/req-<prompt_name>`: `.codex/skills/req-<prompt_name>` when `--enable-codex` AND skills are active; `.github/skills/req-<prompt_name>` when `--enable-github` AND skills are active; `.gemini/skills/req-<prompt_name>` when `--enable-gemini` AND skills are active; `.kiro/skills/req-<prompt_name>` when `--enable-kiro` AND skills are active; `.claude/skills/req-<prompt_name>` when `--enable-claude` AND skills are active; `.opencode/skill/req-<prompt_name>` when `--enable-opencode` AND skills are active.
- **SRS-095**: For each skill subdirectory of every enabled provider, the CLI MUST generate `SKILL.md` with YAML front matter containing: `name: req-<prompt_name>`; `description` populated by `extract_skill_description(prompt_frontmatter)` (see SRS-113) escaped for YAML double-quoted strings; `model` and `tools` fields populated using the provider-specific configuration from `models.json` or `models-legacy.json` according to legacy mode, subject to `--enable-models` and `--enable-tools` flags; the prompt body with token substitutions applied.
- **SRS-096**: The CLI MUST create `.gemini/commands` and `.gemini/commands/req` when BOTH `--enable-gemini` AND `--enable-prompts` are active.
- **SRS-097**: For each Markdown prompt, the CLI MUST generate a TOML file in `.gemini/commands/req` by converting Markdown and applying token substitutions when BOTH `--enable-gemini` AND `--enable-prompts` are active.
- **SRS-098**: The CLI MUST create `.kiro/agents` when BOTH `--enable-kiro` AND `--enable-agents` are active; MUST create `.kiro/prompts` when BOTH `--enable-kiro` AND `--enable-prompts` are active.
- **SRS-099**: For each Markdown prompt, the CLI MUST copy to `.kiro/prompts/req.<name>.md` preserving front matter when BOTH `--enable-kiro` AND `--enable-prompts` are active.
- **SRS-100**: For each Markdown prompt, the CLI MUST generate a JSON agent file in `.kiro/agents` using the agent template from `models.json` when BOTH `--enable-kiro` AND `--enable-agents` are active.
- **SRS-101**: The implementation MUST preserve this behavior exactly: In file Kiro JSON, popolare campi `name`, `description`, `prompt` (body escaped).
- **SRS-102**: The implementation MUST preserve this behavior exactly: In file Kiro JSON, popolare campo `resources` con il file prompt relativo e requisiti.
- **SRS-103**: The implementation MUST preserve this behavior exactly: Popolare `tools` e `allowedTools` in `.kiro/agents` basandosi su `config.json` e mode prompt.
- **SRS-104**: The CLI MUST create `.opencode/agent` when BOTH `--enable-opencode` AND `--enable-agents` are active; MUST create `.opencode/command` when BOTH `--enable-opencode` AND `--enable-prompts` are active.
- **SRS-105**: For each Markdown prompt, the CLI MUST generate a Markdown file in `.opencode/agent` with front matter and `mode: all` when BOTH `--enable-opencode` AND `--enable-agents` are active.
- **SRS-106**: For each Markdown prompt, the CLI MUST generate a file in `.opencode/command` with front matter (agent ref if `--prompts-use-agents` is enabled, optional model/tools) when BOTH `--enable-opencode` AND `--enable-prompts` are active.
- **SRS-107**: The CLI MUST create `.claude/agents` when BOTH `--enable-claude` AND `--enable-agents` are active.
- **SRS-108**: For each Markdown prompt, the CLI MUST generate `.claude/agents/req.<name>.md` with token substitutions when BOTH `--enable-claude` AND `--enable-agents` are active.
- **SRS-109**: In `.claude/agents`, the front matter MUST include `name` and `description`; `model`/`tools` MUST be included only if `--enable-models`/`--enable-tools` are active and the value is configured. This applies when BOTH `--enable-claude` AND `--enable-agents` are active.
- **SRS-110**: The CLI MUST create `.claude/commands/req` when BOTH `--enable-claude` AND `--enable-prompts` are active.
- **SRS-111**: For each Markdown prompt, the CLI MUST generate a file in `.claude/commands/req` with front matter (agent ref if `--prompts-use-agents` is enabled, optional model/tools/allowed-tools) when BOTH `--enable-claude` AND `--enable-prompts` are active.

- **SRS-112**: The CLI MUST accept three artifact-type controls: `--enable-prompts` (default: false), `--enable-agents` (default: false), and `--disable-skills` (default: false). These controls operate orthogonally to provider flags and are evaluated per provider at generation time: `--enable-prompts` enables generation of prompt/command artifact files for each enabled provider; `--enable-agents` enables generation of agent artifact files for each enabled provider; skills are enabled by default and `--disable-skills` disables generation of skill artifact files for each enabled provider. During normal installation (non-upgrade/remove/help), at least one artifact type MUST be active; if none is active, the CLI MUST print an error message in English and exit with exit code 4. The artifact-type controls apply to each enabled provider independently: if a provider does not produce a given artifact type (e.g., Gemini produces only prompts, not agents), the corresponding control has no visible effect for that provider.
- **SRS-113**: The CLI MUST implement `extract_skill_description(frontmatter: str) -> str` that: (1) parses `frontmatter` as YAML (the prompt front matter without the leading/trailing `---` delimiters); (2) extracts the scalar field `usage` from the parsed YAML mapping; (3) normalizes `usage` by converting it to a string, splitting on all whitespace, and joining with a single ASCII space to form a single line; (4) returns the resulting string. If the YAML cannot be parsed, the parsed document is not a mapping, or the `usage` field is missing/empty, the function MUST return the empty string. The function MUST NOT derive the skill description from prompt-body sections (e.g., `## Purpose`, `## Scope`, `## Usage`).
- **SRS-114**: For each Markdown prompt, the CLI MUST generate `.claude/skills/req-<prompt_name>/SKILL.md` with YAML front matter (`name`, `description` from SRS-113, optional `model`/`tools`) and prompt body with token substitutions, using the `claude` configuration from `models.json`, when `--enable-claude` is active and `--disable-skills` is absent.
- **SRS-115**: For each Markdown prompt, the CLI MUST generate `.gemini/skills/req-<prompt_name>/SKILL.md` with YAML front matter (`name`, `description` from SRS-113, optional `model`/`tools`) and prompt body with token substitutions, using the `gemini` configuration from `models.json`, when `--enable-gemini` is active and `--disable-skills` is absent.
- **SRS-116**: For each Markdown prompt, the CLI MUST generate `.opencode/skill/req-<prompt_name>/SKILL.md` with YAML front matter (`name`, `description` from SRS-113, optional `model`/`tools`) and prompt body with token substitutions, using the `opencode` configuration from `models.json`, when `--enable-opencode` is active and `--disable-skills` is absent.
- **SRS-117**: For each Markdown prompt, the CLI MUST generate `.github/skills/req-<prompt_name>/SKILL.md` with YAML front matter (`name`, `description` from SRS-113, optional `model`/`tools`) and prompt body with token substitutions, using the `copilot` configuration from `models.json`, when `--enable-github` is active and `--disable-skills` is absent.
- **SRS-118**: For each Markdown prompt, the CLI MUST generate `.kiro/skills/req-<prompt_name>/SKILL.md` with YAML front matter (`name`, `description` from SRS-113, optional `model`/`tools`) and prompt body with token substitutions, using the `kiro` configuration from `models.json`, when `--enable-kiro` is active and `--disable-skills` is absent.
- **SRS-238**: For skill artifact generation, the CLI MUST process Markdown files only from `src/usereq/resources/prompts`, while prompt and agent artifacts MUST be generated only from `src/usereq/resources/prompts`.

### 3.4 Removal and Cleanup
- **SRS-119**: The implementation MUST preserve this behavior exactly: Il comando deve supportare l'opzione `--remove` per rimuovere risorse create.
- **SRS-120**: The implementation MUST preserve this behavior exactly: Con `--remove`, richiedere obbligatoriamente `--base` o `--here` e rifiutare `--guidelines-dir`, `--update`.
- **SRS-121**: The implementation MUST preserve this behavior exactly: Con `--remove`, verificare esistenza `.req/config.json`.
- **SRS-122**: The implementation MUST preserve this behavior exactly: Con `--remove`, NON ripristinare `.vscode/settings.json` dai backup.
- **SRS-123**: The implementation MUST preserve this behavior exactly: Con `--remove`, rimuovere risorse create: `.codex`, `.github`, `.gemini`, `.kiro`, `.req`, etc.
- **SRS-124**: The implementation MUST preserve this behavior exactly: Dopo rimozione, eliminare sottocartelle vuote nei provider folder.
- **SRS-125**: The implementation MUST preserve this behavior exactly: Con `--remove`, rimuovere file generati in `.claude` e `.opencode` ed eliminare directory vuote.
- **SRS-126**: The implementation MUST preserve this behavior exactly: Con `--remove`, non modificare mai `.vscode/settings.json` esistente.

### 3.5 CI/CD Release Workflow
- **SRS-127**: The implementation MUST preserve this behavior exactly: Il repository deve includere workflow GitHub Actions che scatta su push di tag `v*`.
- **SRS-128**: The implementation MUST preserve this behavior exactly: Il workflow deve eseguire build pacchetto Python (sdist e wheel) in `dist/`.
- **SRS-129**: The implementation MUST preserve this behavior exactly: Il workflow deve creare GitHub Release per il tag e caricare asset da `dist/`.
- **SRS-130**: The implementation MUST preserve this behavior exactly: Il workflow deve generare attestazioni artefatto per file in `dist/`.

### 3.6 Source Analysis Core
- **SRS-131**: The implementation MUST preserve this behavior exactly: Il modulo `usereq.source_analyzer` deve supportare 20 linguaggi di programmazione: C (`.c`), C++ (`.cpp`), C# (`.cs`), Elixir (`.ex`), Go (`.go`), Haskell (`.hs`), Java (`.java`), JavaScript (`.js`), Kotlin (`.kt`), Lua (`.lua`), Perl (`.pl`), PHP (`.php`), Python (`.py`), Ruby (`.rb`), Rust (`.rs`), Scala (`.scala`), Shell (`.sh`), Swift (`.swift`), TypeScript (`.ts`), Zig (`.zig`).
- **SRS-132**: The implementation MUST preserve this behavior exactly: Per ciascun linguaggio, il modulo deve riconoscere e classificare i seguenti tipi di elementi: `FUNCTION`, `METHOD`, `CLASS`, `STRUCT`, `ENUM`, `TRAIT`, `INTERFACE`, `MODULE`, `IMPL`, `MACRO`, `CONSTANT`, `VARIABLE`, `TYPE_ALIAS`, `IMPORT`, `DECORATOR`, `COMMENT_SINGLE`, `COMMENT_MULTI`, `COMPONENT`, `PROTOCOL`, `EXTENSION`, `UNION`, `NAMESPACE`, `PROPERTY`, `SIGNAL`, `TYPEDEF`.
- **SRS-133**: The implementation MUST preserve this behavior exactly: Ogni elemento riconosciuto deve contenere: tipo elemento, riga iniziale, riga finale, estratto del codice sorgente (massimo 5 righe), nome opzionale, firma opzionale, visibilità opzionale, nome genitore opzionale, ereditarietà opzionale, profondità gerarchica.
- **SRS-134**: The implementation MUST preserve this behavior exactly: Il parametro linguaggio deve essere normalizzato: deve accettare maiuscole, minuscole, case misto, punto iniziale e spazi.
- **SRS-135**: The implementation MUST preserve this behavior exactly: Per ciascun linguaggio, il modulo deve riconoscere i commenti a riga singola con il delimitatore appropriato e i commenti multi-riga con i delimitatori di apertura e chiusura specifici del linguaggio.
- **SRS-136**: The implementation MUST preserve this behavior exactly: Il modulo deve supportare alias dei linguaggi (es. `js` per `javascript`, `ts` per `typescript`, `rs` per `rust`, `py` per `python`, `rb` per `ruby`, `hs` per `haskell`, `cs` per `csharp`, `kt` per `kotlin`, `ex` per `elixir`, `sh`/`bash`/`zsh` per `shell`, `cc`/`cxx` per `cpp`, `h` per `c`, `hpp` per `cpp`, `pl` per `perl`, `exs` per `elixir`). Gli alias devono produrre risultati identici al linguaggio canonico.
- **SRS-137**: The implementation MUST preserve this behavior exactly: Il modulo deve gestire la gerarchia degli elementi: gli elementi contenitore (class, struct, module, etc.) devono rimanere a profondità 0, gli elementi contenuti devono avere profondità 1 e il campo `parent_name` impostato.
- **SRS-138**: The implementation MUST preserve this behavior exactly: Il metodo `enrich()` deve arricchire gli elementi con firme pulite, gerarchia, visibilità, ereditarietà, commenti interni e punti di uscita.
- **SRS-139**: The implementation MUST preserve this behavior exactly: La funzione `format_markdown()` deve produrre un output Markdown compatto ottimizzato per il contesto LLM, strutturato con: header file (nome, linguaggio, linee), tabella `Definitions` (simbolo, tipo, linea, firma), tabella `Symbol Index` (indice navigabile), e sezioni opzionali per commenti e imports.
- **SRS-140**: The implementation MUST preserve this behavior exactly: Il modulo deve gestire correttamente: file vuoti (restituire lista vuota), file con solo spazi (restituire lista vuota), linguaggi non supportati (lanciare `ValueError`), file non trovati (lanciare `FileNotFoundError`).
- **SRS-141**: The implementation MUST preserve this behavior exactly: La ricerca della fine dei blocchi deve utilizzare strategie specifiche per famiglia di linguaggio: indentazione per Python e Haskell, parentesi graffe per C/C++/Rust/JavaScript/TypeScript/Java/Go/C#/Swift/Kotlin/PHP/Scala/Zig, keyword `end` per Ruby/Elixir/Lua.
- **SRS-142**: The implementation MUST preserve this behavior exactly: I commenti all'interno di stringhe letterali non devono essere riconosciuti come commenti.
- **SRS-143**: The implementation MUST preserve this behavior exactly: Il modulo `usereq.source_analyzer` deve estrarre i blocchi di commento di documentazione associati a ciascun costrutto e archiviarli in `SourceElement` per il parsing Doxygen a valle.

### 3.7 Token Counting
- **SRS-144**: The implementation MUST preserve this behavior exactly: Il modulo `usereq.token_counter` deve contare i token usando la codifica `tiktoken` con encoding `cl100k_base` come default.
- **SRS-145**: The implementation MUST preserve this behavior exactly: La classe `TokenCounter` deve esporre i metodi `count_tokens(content)` e `count_chars(content)`.
- **SRS-146**: The implementation MUST preserve this behavior exactly: La funzione `count_file_metrics(content, encoding_name)` deve restituire un dizionario con chiavi `tokens` e `chars`.
- **SRS-147**: The implementation MUST preserve this behavior exactly: La funzione `count_files_metrics(file_paths, encoding_name)` deve restituire una lista di dizionari con chiavi `file`, `tokens`, `chars` e opzionalmente `error` in caso di errore di lettura.
- **SRS-148**: The implementation MUST preserve this behavior exactly: La funzione `format_pack_summary(results)` deve formattare un riepilogo con dettagli per file e totali, usando il formato: nome file, conteggio token, conteggio caratteri, e una sezione Pack Summary con totali.
- **SRS-149**: The implementation MUST preserve this behavior exactly: In caso di errore di conteggio token (eccezione nell'encoding), il conteggio deve restituire 0 senza propagare l'eccezione.

### 3.8 Reference Markdown Generation
- **SRS-150**: The implementation MUST preserve this behavior exactly: Il modulo `usereq.generate_markdown` deve analizzare file sorgente utilizzando `usereq.source_analyzer` e produrre un output markdown concatenato.
- **SRS-151**: The implementation MUST preserve this behavior exactly: Il modulo deve determinare il linguaggio dal file extension utilizzando la mappa estensione-linguaggio supportata.
- **SRS-152**: The implementation MUST preserve this behavior exactly: I file non trovati devono essere ignorati; il messaggio SKIP su stderr deve essere stampato solo quando la modalità verbose è attiva.
- **SRS-153**: The implementation MUST preserve this behavior exactly: I file con estensione non supportata devono essere ignorati; il messaggio SKIP su stderr deve essere stampato solo quando la modalità verbose è attiva.
- **SRS-154**: The implementation MUST preserve this behavior exactly: Se nessun file valido viene processato, deve essere lanciata una eccezione `ValueError`.
- **SRS-155**: The implementation MUST preserve this behavior exactly: I risultati di analisi markdown devono essere concatenati con separatore `\n\n---\n\n`.
- **SRS-156**: The implementation MUST preserve this behavior exactly: Lo stato di elaborazione (OK/FAIL e conteggio) deve essere stampato su stderr solo quando la modalità verbose è attiva. L'output markdown per ciascun costrutto deve includere esclusivamente il riferimento del costrutto e i campi Doxygen estratti (se presenti), formattati come lista Markdown puntata; non deve includere righe legacy di commenti/exit points nel formato `L<n>>`.

### 3.9 Source Compression
- **SRS-157**: The implementation MUST preserve this behavior exactly: Il modulo `usereq.compress` deve comprimere il codice sorgente rimuovendo commenti (inline, a riga singola, multi-riga), righe vuote, spazi finali e spaziatura ridondante, preservando la semantica del linguaggio.
- **SRS-158**: The implementation MUST preserve this behavior exactly: Per i linguaggi con indentazione significativa (Python, Haskell, Elixir), l'indentazione deve essere preservata durante la compressione.
- **SRS-159**: The implementation MUST preserve this behavior exactly: Il formato di output deve supportare i prefissi con numero di riga nel formato `<n>: <testo>`, abilitati di default e disabilitabili con l'opzione `include_line_numbers=False`.
- **SRS-160**: The implementation MUST preserve this behavior exactly: Le shebang lines (`#!`) alla prima riga del file devono essere preservate.
- **SRS-161**: The implementation MUST preserve this behavior exactly: I commenti all'interno di stringhe letterali non devono essere rimossi.
- **SRS-162**: The implementation MUST preserve this behavior exactly: Il modulo deve determinare automaticamente il linguaggio dall'estensione del file, con possibilità di override manuale.
- **SRS-163**: The implementation MUST preserve this behavior exactly: Il modulo `usereq.compress_files` deve comprimere e concatenare file sorgente multipli, producendo per ciascun file un header nel formato `@@@ <percorso> | <linguaggio>`, una riga metadato `- Lines: <riga_iniziale>-<riga_finale>` e il contenuto compresso racchiuso in un blocco Markdown delimitato da triple backtick.
- **SRS-164**: The implementation MUST preserve this behavior exactly: I file non trovati devono essere ignorati; il messaggio SKIP su stderr deve essere stampato solo quando la modalità verbose è attiva.
- **SRS-165**: The implementation MUST preserve this behavior exactly: I file con estensione non supportata devono essere ignorati; il messaggio SKIP su stderr deve essere stampato solo quando la modalità verbose è attiva.
- **SRS-166**: The implementation MUST preserve this behavior exactly: Se nessun file valido viene processato, deve essere lanciata una eccezione `ValueError`.
- **SRS-167**: The implementation MUST preserve this behavior exactly: Lo stato di elaborazione (OK/FAIL e conteggio) deve essere stampato su stderr solo quando la modalità verbose è attiva.
- **SRS-168**: The implementation MUST preserve this behavior exactly: I blocchi di commenti multi-riga (incluse docstrings Python con `"""` e `'''`) devono essere rimossi nella compressione.

### 3.10 Construct Extraction and Command Operations
- **SRS-169**: The implementation MUST preserve this behavior exactly: Il comando `--files-tokens` deve accettare una lista di file come parametro e calcolare il conteggio token e caratteri per ciascun file, stampando un riepilogo con dettagli per file e totali su stdout.
- **SRS-170**: The implementation MUST preserve this behavior exactly: Il comando `--files-tokens` deve operare indipendentemente da `--base`, `--here` e dalla configurazione di useReq. I parametri `--base` e `--here` non devono essere richiesti.
- **SRS-171**: The implementation MUST preserve this behavior exactly: Il comando `--files-tokens` deve ignorare i file non trovati con un avviso su stderr e terminare con errore se nessun file valido è fornito.
- **SRS-172**: The implementation MUST preserve this behavior exactly: The `--files-references` command MUST accept an arbitrary list of files and generate structured reference markdown for LLM context on stdout; for each construct it MUST emit the construct reference and extracted Doxygen fields (when present) in the format defined by SRS-219 and SRS-221. The rendered file line `> Path: \`...\`` MUST be relative to the project home (current working directory) and MUST NOT be absolute.
- **SRS-173**: The implementation MUST preserve this behavior exactly: Il comando `--files-references` deve operare indipendentemente da `--base`, `--here` e dalla configurazione di useReq. I parametri `--base` e `--here` non devono essere richiesti.
- **SRS-174**: The implementation MUST preserve this behavior exactly: Il comando `--files-compress` deve accettare una lista arbitraria di file e generare un output compresso per il contesto LLM, stampandolo su stdout.
- **SRS-175**: The implementation MUST preserve this behavior exactly: Il comando `--files-compress` deve operare indipendentemente da `--base`, `--here` e dalla configurazione di useReq. I parametri `--base` e `--here` non devono essere richiesti.
- **SRS-176**: The implementation MUST preserve this behavior exactly: Il comando `--references` deve richiedere `--base` o `--here` per determinare il contesto di esecuzione. Se nessuno dei due è presente, il comando deve terminare con un messaggio di errore che indica i parametri obbligatori.
- **SRS-177**: The implementation MUST preserve this behavior exactly: The `--references` command MUST generate reference markdown using all files with supported extensions (as defined in SRS-131) found in effective source directories: with `--base` it MUST use `--src-dir` when provided, otherwise `src-dir` from `config.json`; with `--here` it MUST use only `src-dir` from `config.json` and ignore explicit `--src-dir`. For each construct it MUST emit the construct reference and extracted Doxygen fields (when present) in the format defined by SRS-219 and SRS-221. The rendered file line `> Path: \`...\`` MUST be relative to the resolved project home and MUST NOT be absolute.
- **SRS-178**: The implementation MUST preserve this behavior exactly: Il comando `--compress` deve richiedere `--base` o `--here` per determinare il contesto di esecuzione. Se nessuno dei due è presente, il comando deve terminare con un messaggio di errore che indica i parametri obbligatori.
- **SRS-179**: The implementation MUST preserve this behavior exactly: Il comando `--compress` deve eseguire la compressione sorgenti utilizzando come input tutti i file con estensione supportata (come definiti in SRS-131) trovati nelle directory sorgenti effettive: con `--base` usa `--src-dir` se presente altrimenti `src-dir` da `config.json`; con `--here` deve usare solo `src-dir` da `config.json` ignorando eventuali `--src-dir` espliciti.
- **SRS-180**: The implementation MUST preserve this behavior exactly: Durante la scansione delle directory sorgenti per i comandi `--references` e `--compress`, le seguenti directory devono essere escluse (elenco hardcoded): `.git`, `.vscode`, `tmp`, `temp`, `.cache`, `.pytest_cache`, `node_modules`, `__pycache__`, `.venv`, `venv`, `dist`, `build`, `.tox`, `.mypy_cache`, `.ruff_cache`.
- **SRS-181**: The implementation MUST preserve this behavior exactly: La scansione delle directory sorgenti per i comandi `--references` e `--compress` deve essere ricorsiva, esaminando tutte le sottodirectory delle directory sorgenti configurate, escludendo le directory elencate in SRS-180.
- **SRS-182**: The implementation MUST preserve this behavior exactly: I comandi `--references` e `--compress`, quando utilizzati con `--update`, devono caricare le directory sorgenti dal campo `src-dir` del file `config.json`.
- **SRS-183**: The implementation MUST preserve this behavior exactly: Il comando `--references` deve anteporre al markdown generato una sezione `# Files Structure` contenente l'albero ASCII dei file effettivamente selezionati dalla scansione (`--src-dir` o `src-dir` da configurazione), applicando gli stessi filtri di estensione supportata (SRS-131) ed esclusione directory (SRS-180); l'albero deve essere racchiuso in code fence Markdown.
- **SRS-184**: The implementation MUST preserve this behavior exactly: Il comando `--tokens` deve richiedere `--base` o `--here`; con `--base` deve richiedere `--docs-dir`, mentre con `--here` deve usare `docs-dir` da `config.json` ignorando eventuali `--docs-dir` espliciti. La directory documentazione effettiva deve essere risolta rispetto alla root progetto, i file regolari direttamente presenti devono essere elaborati tramite il flusso `--files-tokens`, e il riepilogo deve essere stampato su stdout.
- **SRS-185**: The implementation MUST preserve this behavior exactly: I comandi `--files-compress` e `--compress` devono accettare il flag opzionale `--enable-line-numbers`; quando il flag è assente l'output compresso non deve includere i prefissi `<numero>:`, quando il flag è presente i prefissi devono essere inclusi.
- **SRS-186**: The implementation MUST preserve this behavior exactly: Il modulo `usereq.find_constructs` deve estrarre costrutti specifici da file sorgente filtrando per tipo elemento (`TAG`) e nome elemento tramite pattern regex (`REGEXP`).
- **SRS-187**: The implementation MUST preserve this behavior exactly: Il parametro `<TAG>` deve accettare uno o più identificatori di tipo elemento separati dal carattere `|`. Gli identificatori validi per linguaggio sono: Python (`CLASS`, `FUNCTION`, `DECORATOR`, `IMPORT`, `VARIABLE`), C (`STRUCT`, `UNION`, `ENUM`, `TYPEDEF`, `MACRO`, `FUNCTION`, `IMPORT`, `VARIABLE`), C++ (`CLASS`, `STRUCT`, `ENUM`, `NAMESPACE`, `FUNCTION`, `MACRO`, `IMPORT`, `TYPE_ALIAS`), Rust (`FUNCTION`, `STRUCT`, `ENUM`, `TRAIT`, `IMPL`, `MODULE`, `MACRO`, `CONSTANT`, `TYPE_ALIAS`, `IMPORT`, `DECORATOR`), JavaScript (`CLASS`, `FUNCTION`, `COMPONENT`, `CONSTANT`, `IMPORT`, `MODULE`), TypeScript (`INTERFACE`, `TYPE_ALIAS`, `ENUM`, `CLASS`, `FUNCTION`, `NAMESPACE`, `MODULE`, `IMPORT`, `DECORATOR`), Java (`CLASS`, `INTERFACE`, `ENUM`, `FUNCTION`, `IMPORT`, `MODULE`, `DECORATOR`, `CONSTANT`), Go (`FUNCTION`, `METHOD`, `STRUCT`, `INTERFACE`, `TYPE_ALIAS`, `CONSTANT`, `IMPORT`, `MODULE`), Ruby (`CLASS`, `MODULE`, `FUNCTION`, `CONSTANT`, `IMPORT`, `DECORATOR`), PHP (`CLASS`, `INTERFACE`, `TRAIT`, `FUNCTION`, `NAMESPACE`, `IMPORT`, `CONSTANT`), Swift (`CLASS`, `STRUCT`, `ENUM`, `PROTOCOL`, `EXTENSION`, `FUNCTION`, `IMPORT`, `CONSTANT`, `VARIABLE`), Kotlin (`CLASS`, `INTERFACE`, `ENUM`, `FUNCTION`, `CONSTANT`, `VARIABLE`, `MODULE`, `IMPORT`, `DECORATOR`), Scala (`CLASS`, `TRAIT`, `MODULE`, `FUNCTION`, `CONSTANT`, `VARIABLE`, `TYPE_ALIAS`, `IMPORT`), Lua (`FUNCTION`, `VARIABLE`), Shell (`FUNCTION`, `VARIABLE`, `IMPORT`), Perl (`FUNCTION`, `MODULE`, `IMPORT`, `CONSTANT`), Haskell (`MODULE`, `TYPE_ALIAS`, `STRUCT`, `CLASS`, `FUNCTION`, `IMPORT`), Zig (`FUNCTION`, `STRUCT`, `ENUM`, `UNION`, `CONSTANT`, `VARIABLE`, `IMPORT`), Elixir (`MODULE`, `FUNCTION`, `PROTOCOL`, `IMPL`, `STRUCT`, `IMPORT`), C# (`CLASS`, `INTERFACE`, `STRUCT`, `ENUM`, `NAMESPACE`, `FUNCTION`, `PROPERTY`, `IMPORT`, `DECORATOR`, `CONSTANT`).
- **SRS-188**: The implementation MUST preserve this behavior exactly: Il parametro `<REGEXP>` deve essere una espressione regolare Python (sintassi `re` module) applicata al nome del costrutto estratto. Il match deve essere case-sensitive e testato con `re.search()`.
- **SRS-189**: The implementation MUST preserve this behavior exactly: Se un file sorgente non supporta nessuno dei tag specificati in `<TAG>` per il suo linguaggio, il file deve essere saltato; il messaggio SKIP su stderr deve essere stampato solo quando la modalità verbose è attiva.
- **SRS-190**: The implementation MUST preserve this behavior exactly: La funzione `find_constructs_in_files()` deve analizzare ciascun file con `SourceAnalyzer.analyze()` e `SourceAnalyzer.enrich()`, filtrare gli elementi per tag e regex, usare i commenti associati al costrutto processati in `SourceAnalyzer.enrich()` per popolare i campi `doxygen_fields`, leggere il contenuto completo di ciascun costrutto filtrato dal file sorgente utilizzando gli indici `line_start` e `line_end`, normalizzare il blocco codice rimuovendo commenti inline/single-line/multi-line senza alterare stringhe letterali e senza alterare la semantica del costrutto, e formattare l'output in markdown.
- **SRS-191**: The implementation MUST preserve this behavior exactly: Il formato di output markdown deve contenere per ciascun file un header `@@@ <percorso> | <linguaggio>`, seguito dall'elenco dei costrutti trovati con: tipo costrutto, nome, firma (se presente), riga iniziale, riga finale, campi Doxygen estratti formattati come lista Markdown puntata (se presenti), blocco codice del costrutto estratto dagli indici `line_start` e `line_end` del `SourceElement` senza troncamento con `...` e con rimozione di commenti inline/single-line/multi-line; i contenuti Doxygen devono rimanere disponibili esclusivamente nelle etichette markdown previste da SRS-220 e non nel blocco codice estratto.
- **SRS-192**: The implementation MUST preserve this behavior exactly: Il codice estratto per ciascun costrutto deve includere i prefissi con numero di riga nel formato `<n>: <testo>` per default. I prefissi devono essere disabilitabili con l'opzione `include_line_numbers=False`.
- **SRS-193**: The implementation MUST preserve this behavior exactly: Lo stato di elaborazione (OK/SKIP/FAIL e conteggio) deve essere stampato su stderr solo quando la modalità verbose è attiva.
- **SRS-194**: The implementation MUST preserve this behavior exactly: Se nessun file valido viene processato o nessun costrutto viene trovato, deve essere lanciata una eccezione `ValueError`.
- **SRS-195**: The implementation MUST preserve this behavior exactly: I file non trovati devono essere ignorati; il messaggio SKIP su stderr deve essere stampato solo quando la modalità verbose è attiva.
- **SRS-196**: The implementation MUST preserve this behavior exactly: I file con estensione non supportata devono essere ignorati; il messaggio SKIP su stderr deve essere stampato solo quando la modalità verbose è attiva.
- **SRS-197**: The implementation MUST preserve this behavior exactly: Il modulo `usereq.find_constructs` deve fornire una funzione `format_available_tags()` che genera l'elenco formattato dei TAG disponibili per linguaggio, iterando dinamicamente sulla mappa `LANGUAGE_TAGS`. Il formato di output deve essere multi-riga con ogni linguaggio su una riga separata nel formato: `- <Linguaggio>: TAG1, TAG2, TAG3, ...` (linguaggio con prima lettera maiuscola, TAG separati da virgola+spazio, ordinati alfabeticamente).
- **SRS-198**: The implementation MUST preserve this behavior exactly: Il comando `--files-find` deve accettare due parametri obbligatori `<TAG>` e `<REGEXP>`, seguiti da una lista arbitraria di file: `--files-find <TAG> <REGEXP> <FILE1> <FILE2> ...`. Se `<TAG>` non contiene identificatori validi o non è supportato da nessun linguaggio processato, il comando deve stampare un messaggio di errore che include l'elenco completo dei TAG disponibili per linguaggio, generato dinamicamente utilizzando la mappa `LANGUAGE_TAGS` definita in `find_constructs.py`.
- **SRS-199**: Invalid regex input for construct extraction MUST be treated as a non-match condition, resulting in the generic 'no constructs found' error rather than a regex syntax exception.
- **SRS-200**: The implementation MUST preserve this behavior exactly: Il comando `--files-find` deve operare indipendentemente da `--base`, `--here` e dalla configurazione di useReq. I parametri `--base` e `--here` non devono essere richiesti.
- **SRS-201**: The implementation MUST preserve this behavior exactly: Il comando `--files-find` deve estrarre e stampare su stdout tutti i costrutti che: appartengono ai tipi specificati in `<TAG>` (separati da `|`), hanno nome che esegue il match con `<REGEXP>`, sono presenti nei file specificati.
- **SRS-202**: The implementation MUST preserve this behavior exactly: Il comando `--files-find` deve accettare il flag opzionale `--enable-line-numbers`; quando il flag è assente l'output non deve includere i prefissi `<numero>:`, quando il flag è presente i prefissi devono essere inclusi.
- **SRS-203**: The implementation MUST preserve this behavior exactly: Il comando `--find` deve richiedere `--base` o `--here` per determinare il contesto di esecuzione. Se nessuno dei due è presente, il comando deve terminare con un messaggio di errore che indica i parametri obbligatori.
- **SRS-204**: The implementation MUST preserve this behavior exactly: Il comando `--find` deve accettare due parametri obbligatori `<TAG>` e `<REGEXP>`: `--find <TAG> <REGEXP>`. Se `<TAG>` non contiene identificatori validi o non è supportato da nessun linguaggio processato, il comando deve stampare un messaggio di errore che include l'elenco completo dei TAG disponibili per linguaggio, generato dinamicamente utilizzando la mappa `LANGUAGE_TAGS` definita in `find_constructs.py`.
- **SRS-205**: The implementation MUST preserve this behavior exactly: Il comando `--find` deve eseguire l'estrazione costrutti utilizzando come input tutti i file con estensione supportata (come definiti in SRS-131) trovati nelle directory sorgenti effettive: con `--base` usa `--src-dir` se presente altrimenti `src-dir` da `config.json`; con `--here` deve usare solo `src-dir` da `config.json` ignorando eventuali `--src-dir` espliciti.
- **SRS-206**: The implementation MUST preserve this behavior exactly: Durante la scansione delle directory sorgenti per il comando `--find`, le directory elencate in SRS-180 devono essere escluse.
- **SRS-207**: The implementation MUST preserve this behavior exactly: La scansione delle directory sorgenti per il comando `--find` deve essere ricorsiva, esaminando tutte le sottodirectory delle directory sorgenti configurate, escludendo le directory elencate in SRS-180.
- **SRS-208**: The implementation MUST preserve this behavior exactly: Il comando `--find`, quando utilizzato con `--update`, deve caricare le directory sorgenti dal campo `src-dir` del file `config.json`.
- **SRS-209**: The implementation MUST preserve this behavior exactly: Il comando `--find` deve accettare il flag opzionale `--enable-line-numbers`; quando il flag è assente l'output non deve includere i prefissi `<numero>:`, quando il flag è presente i prefissi devono essere inclusi.
- **SRS-210**: The implementation MUST preserve this behavior exactly: I comandi `--files-references`, `--references`, `--files-compress`, `--compress`, `--files-find` e `--find` devono stampare su stderr gli output di stato elaborazione (OK/SKIP/FAIL e riepiloghi) solo quando è presente il flag `--verbose`; senza `--verbose` tali output non devono essere stampati.
- **SRS-211**: The implementation MUST preserve this behavior exactly: The `--files-compress` and `--compress` commands MUST print, for each processed file, the same structured payload: header `@@@ <path> | <language>`, line `- Lines: <line_start>-<line_end>` with range derived from existing `<n>:` numbering logic, and a code block delimited by triple backticks. The `<path>` value in the header MUST be relative to the project home and MUST NOT be absolute; for `--compress` project home is the resolved `--base`/`--here` root, and for `--files-compress` project home is the current working directory. Existing line-number range computation logic MUST NOT be changed.

### 3.11 Doxygen Parsing and Field Emission
- **SRS-212**: The implementation MUST preserve this behavior exactly: Il modulo `usereq.doxygen_parser` deve estrarre campi Doxygen da commenti di documentazione seguendo la sintassi standard Doxygen per tutti i linguaggi supportati.
- **SRS-213**: The implementation MUST preserve this behavior exactly: Il parser deve riconoscere i seguenti tag Doxygen: @brief, @details, @param, @param[in], @param[out], @return, @retval, @exception, @throws, @warning, @deprecated, @note, @see, @sa, @pre, @post.
- **SRS-214**: The implementation MUST preserve this behavior exactly: La funzione `parse_doxygen_comment(comment_text: str) -> Dict[str, List[str]]` deve restituire un dizionario dove le chiavi sono i tag Doxygen normalizzati e i valori sono liste di contenuti estratti.
- **SRS-215**: The implementation MUST preserve this behavior exactly: Il parser deve supportare sia la sintassi `@tag` che `\tag` per la compatibilità Doxygen standard.
- **SRS-216**: The implementation MUST preserve this behavior exactly: Per tag `@param` il parser deve distinguere tra `@param`, `@param[in]`, e `@param[out]` preservando la direzionalità.
- **SRS-217**: The implementation MUST preserve this behavior exactly: Il contenuto di ciascun tag deve estendersi fino al prossimo tag Doxygen o alla fine del commento, con normalizzazione degli spazi.
- **SRS-218**: The implementation MUST preserve this behavior exactly: Il modulo `usereq.source_analyzer` deve invocare `parse_doxygen_comment()` sui commenti associati ai costrutti e popolare un nuovo campo `doxygen_fields` in `SourceElement`.
- **SRS-219**: The implementation MUST preserve this behavior exactly: I comandi `--files-references` e `--references` devono formattare l'output Doxygen come lista Markdown puntata con prefisso tag capitalizzato senza chiocciola, aggiungendo ':' (es: `@brief` → `- Brief:`). Se nessun campo Doxygen è presente, l'output deve contenere solo il riferimento del costrutto.
- **SRS-220**: The implementation MUST preserve this behavior exactly: I comandi `--files-find` e `--find` devono inserire i campi Doxygen estratti dopo la riga `- Lines: ...` e prima del blocco codice. Il formato deve essere lista Markdown puntata con prefisso derivato dal tag Doxygen senza carattere iniziale `@`, con primo carattere maiuscolo e suffisso `:` (es: `@brief` → `- Brief:`, `@exception` → `- Exception:`, `@sa` → `- Sa:`). Se il costrutto non ha commento Doxygen associato, l'output deve contenere solo i metadati del costrutto senza righe aggiuntive di campi Doxygen.
- **SRS-221**: The implementation MUST preserve this behavior exactly: I campi Doxygen devono essere emessi nell'ordine fisso: @brief, @details, @param, @param[in], @param[out], @return, @retval, @exception, @throws, @warning, @deprecated, @note, @see, @sa, @pre, @post, omettendo tag non presenti.

## 4. Test Requirements

### 4.1 Test and Verification Requirements
- **SRS-222**: The implementation MUST preserve this behavior exactly: Unit test devono usare esclusivamente la cartella `temp/` (o `tests/temp/`).
- **SRS-223**: The implementation MUST preserve this behavior exactly: Il progetto deve includere suite `tests/test_cli.py` che verifica operazioni CLI in cartella temporanea.
- **SRS-224**: The implementation MUST preserve this behavior exactly: Unit test non devono creare/modificare file fuori da `temp/`.
- **SRS-225**: The implementation MUST preserve this behavior exactly: Il progetto deve includere i moduli di test `tests/test_analyzer_core.py`, `tests/test_analyzer_comments.py`, `tests/test_analyzer_format.py`, `tests/test_analyzer_errors.py`, `tests/test_analyzer_helpers.py`, e `tests/test_analyzer_cli.py`.
- **SRS-226**: The implementation MUST preserve this behavior exactly: I test del modulo `source_analyzer` che richiedono fixture linguistiche devono utilizzare i file in `tests/fixtures/` con naming `fixture_<linguaggio>.<estensione>`.
- **SRS-227**: The implementation MUST preserve this behavior exactly: I test del modulo `source_analyzer` che creano file temporanei devono impostare la directory di output sotto `temp/` della repository.
- **SRS-228**: The implementation MUST preserve this behavior exactly: Il progetto deve includere il modulo di test `tests/test_find_constructs_comprehensive.py` che verifica l'estrazione COMPLETA (senza troncamento o snippet limitati) di costrutti specifici tramite `find_constructs_in_files()` per tutte le combinazioni linguaggio-costrutto definite in SRS-187 e per i vincoli quantitativi/eterogeneità commenti definiti in SRS-230, utilizzando le fixture presenti in `tests/fixtures/`, validando che l'output estratto contenga il codice completo di ciascun costrutto dall'inizio alla fine senza limitazioni o simboli `...` di troncamento, ed eseguendo per ogni combinazione linguaggio-TAG almeno 5 estrazioni distinte con pattern regex ancorati su nomi di costrutto differenti.
- **SRS-229**: The implementation MUST preserve this behavior exactly: I fixture di test per tutti i 20 linguaggi devono essere presenti nella directory `tests/fixtures/` con il formato `fixture_<linguaggio>.<estensione>`.
- **SRS-230**: The implementation MUST preserve this behavior exactly: Ogni fixture in `tests/fixtures/fixture_<linguaggio>.<estensione>` deve includere almeno 5 costrutti distinti per ciascun TAG obbligatorio del linguaggio definito in SRS-187; i costrutti devono includere commenti non omogenei distribuiti con almeno una occorrenza per modalità `pre-line`, `inline`, e `multi-line` ove la sintassi del linguaggio lo consente, mantenendo sintassi valida e parsabile dal linguaggio target.
- **SRS-231**: The implementation MUST preserve this behavior exactly: Tutti i file fixture in `tests/fixtures/` devono contenere almeno 5 costrutti documentati con tag Doxygen @brief, @details, @param, @return per ciascun tipo di costrutto obbligatorio del linguaggio definito in SRS-187.
- **SRS-232**: The implementation MUST preserve this behavior exactly: Il progetto deve includere il modulo di test `tests/test_doxygen_parser.py` con almeno 160 test unitari complessivi, derivati da almeno 10 casi per ciascuno dei 16 tag Doxygen supportati in SRS-213; ogni test deve usare un commento sintetico generato per uno scenario specifico del tag target e deve verificare in modo deterministico il risultato atteso dell'estrazione.
- **SRS-233**: The implementation MUST preserve this behavior exactly: Il progetto deve includere test Doxygen basati su `tests/fixtures/` che, per ciascun file fixture, estraggono tutti i costrutti presenti compatibili con SRS-187, validano in modo deterministico i campi Doxygen attesi per ogni costrutto, e verificano che l'associazione commento→costrutto sia corretta sia per commenti pre-costrutto sia per commenti post-costrutto quando consentiti dalla sintassi del linguaggio.
- **SRS-234**: The implementation MUST preserve this behavior exactly: Il progetto deve includere test command-level in `tests/test_files_commands.py` che eseguono il flusso equivalente a `--files-references` su ogni file in `tests/fixtures/`; per ogni file fixture (uno per linguaggio) deve esistere un caso di test dedicato che: (a) conta nel file sorgente tutte le occorrenze dei tag Doxygen definiti in SRS-213, (b) estrae il payload references, (c) conta in output tutte le occorrenze delle etichette `Brief:`, `Details:`, `Param:`, `Param[in]:`, `Param[out]:`, `Return:`, `Retval:`, `Exception:`, `Throws:`, `Warning:`, `Deprecated:`, `Note:`, `See:`, `Sa:`, `Pre:`, `Post:`, (d) verifica uguaglianza esatta tra conteggio totale sorgente e conteggio totale output, (e) verifica per ciascun costrutto target una corrispondenza 1:1 tra contenuto atteso dei campi Doxygen e righe emesse in output (valore completo del campo, inclusi identificatori parametro come `msg` quando presenti), (f) verifica l'assenza di righe legacy `L<n>>` per commenti/exit points nel payload di riferimento.
- **SRS-235**: The implementation MUST preserve this behavior exactly: Il progetto deve includere test command-level in `tests/test_files_commands.py` per `--references` su directory progetto configurata che include `tests/fixtures/`; per ogni file fixture (uno per linguaggio) deve esistere un caso di test dedicato che: (a) conta nel file sorgente tutte le occorrenze dei tag Doxygen definiti in SRS-213, (b) estrae il payload references equivalente al comando `--references`, (c) conta in output tutte le occorrenze delle etichette `Brief:`, `Details:`, `Param:`, `Param[in]:`, `Param[out]:`, `Return:`, `Retval:`, `Exception:`, `Throws:`, `Warning:`, `Deprecated:`, `Note:`, `See:`, `Sa:`, `Pre:`, `Post:`, (d) verifica uguaglianza esatta tra conteggio totale sorgente e conteggio totale output, (e) verifica per ciascun costrutto target una corrispondenza 1:1 tra contenuto atteso dei campi Doxygen e righe emesse in output (valore completo del campo, inclusi identificatori parametro come `msg` quando presenti).
- **SRS-236**: The implementation MUST preserve this behavior exactly: Il progetto deve includere test command-level per `--files-find` (o flusso equivalente `find_constructs_in_files()`) su tutti i file in `tests/fixtures/`; per ogni file fixture (uno per linguaggio) deve esistere un caso di test dedicato che: (a) usa pattern regex specifici del file per estrarre l'insieme target dei costrutti, (b) verifica in modo deterministico che l'output elenchi tutti i costrutti target presenti nel file sorgente, (c) conta nel file sorgente tutte le occorrenze dei tag Doxygen definiti in SRS-213 riferite ai costrutti target, (d) conta in output tutte le occorrenze delle etichette `Brief:`, `Details:`, `Param:`, `Param[in]:`, `Param[out]:`, `Return:`, `Retval:`, `Exception:`, `Throws:`, `Warning:`, `Deprecated:`, `Note:`, `See:`, `Sa:`, `Pre:`, `Post:`, (e) verifica uguaglianza esatta 1:1 tra conteggio totale sorgente e conteggio totale output, (f) verifica per ciascun costrutto target una corrispondenza 1:1 tra contenuto atteso dei campi Doxygen e righe emesse in output (valore completo del campo, inclusi identificatori parametro come `msg` quando presenti), (g) verifica conformità a formato SRS-220 e ordine SRS-221.
- **SRS-237**: The implementation MUST preserve this behavior exactly: Il progetto deve includere test command-level per `--find` su contesto progetto configurato che include `tests/fixtures/`; per ogni file fixture (uno per linguaggio) deve esistere un caso di test dedicato che: (a) usa pattern regex specifici del file per estrarre l'insieme target dei costrutti, (b) verifica in modo deterministico che l'output elenchi tutti i costrutti target presenti nel file sorgente, (c) conta nel file sorgente tutte le occorrenze dei tag Doxygen definiti in SRS-213 riferite ai costrutti target, (d) conta in output tutte le occorrenze delle etichette `Brief:`, `Details:`, `Param:`, `Param[in]:`, `Param[out]:`, `Return:`, `Retval:`, `Exception:`, `Throws:`, `Warning:`, `Deprecated:`, `Note:`, `See:`, `Sa:`, `Pre:`, `Post:`, (e) verifica uguaglianza esatta 1:1 tra conteggio totale sorgente e conteggio totale output, (f) verifica per ciascun costrutto target una corrispondenza 1:1 tra contenuto atteso dei campi Doxygen e righe emesse in output (valore completo del campo, inclusi identificatori parametro come `msg` quando presenti), (g) verifica conformità a formato SRS-220, ordine SRS-221 e fallback senza campi quando il commento Doxygen associato non è presente.

## 5. Static Code Analysis Requirements

### 5.1 Static Analysis Feature Overview
- **SRS-239**: The CLI MUST support a new flag `--test-static-check` that accepts a subcommand name (`dummy`, `pylance`, `ruff`, `command`) and dispatches static-code-analysis logic accordingly. The flag MUST operate as a standalone command (no `--base`/`--here` required).
- **SRS-240**: The `--test-static-check` flag MUST accept an optional list of `[FILES]...` arguments following the subcommand name and optional subcommand-specific options. Each element of `[FILES]` MAY be: a path to a directory (direct children only), a glob pattern (e.g., `path/**/*.py`) with full `**` recursive expansion support, or a specific file path. No custom `--recursive` flag is defined; recursive traversal is expressed via `**` glob syntax.
- **SRS-241**: The implementation MUST provide a `StaticCheckBase` (Dummy) class in `src/usereq/static_check.py` that iterates over resolved input files, emits `# Static-Check(Dummy): <filename> [OPTIONS]`, emits `Result: OK`, and appends exactly one trailing blank line after each per-file markdown block.
- **SRS-242**: The implementation MUST provide a `StaticCheckPylance` class derived from `StaticCheckBase` that invokes `pyright` per resolved file, emits `# Static-Check(Pylance): <filename> [OPTIONS]`, emits `Result: OK` or `Result: FAIL\nEvidence:\n<output>`, and appends exactly one trailing blank line after each per-file markdown block.
- **SRS-243**: The implementation MUST provide a `StaticCheckRuff` class derived from `StaticCheckBase` that invokes `ruff check` per resolved file, emits `# Static-Check(Ruff): <filename> [OPTIONS]`, emits `Result: OK` or `Result: FAIL\nEvidence:\n<output>`, and appends exactly one trailing blank line after each per-file markdown block.
- **SRS-244**: The implementation MUST provide a `StaticCheckCommand` class derived from `StaticCheckBase` that requires `command <cmd>`, validates `cmd` on PATH (`shutil.which`), emits `# Static-Check(Command[<cmd>]): <filename> [OPTIONS]`, emits pass/fail output, and appends exactly one trailing blank line after each per-file markdown block.
- **SRS-245**: All static-check classes MUST resolve `[FILES]` input using glob expansion (with `**` recursive support always enabled) for patterns, and direct-children-only traversal for bare directory entries, collecting only regular files. If the resolved file list is empty, the command MUST print a warning to stderr and exit with code 0.
- **SRS-246**: The `--test-static-check` dispatcher MUST be integrated into `cli.py` as a standalone command dispatched before the standard init flow.

### 5.2 Static Analysis Test Requirements
- **SRS-247**: The project MUST include `tests/test_static_check.py` with unit tests for: `StaticCheckBase` (Dummy) output format with one trailing blank separator line per file block; `StaticCheckPylance` OK/FAIL branches with mocked subprocess; `StaticCheckRuff` OK/FAIL branches with mocked subprocess; `StaticCheckCommand` availability check and OK/FAIL branches with mocked subprocess; glob pattern resolution including `**` recursive expansion; direct-children-only directory resolution; empty-file-list warning behavior.

### 5.3 Static Analysis Configuration Requirements
- **SRS-248**: The CLI MUST support repeatable `--enable-static-check SPEC` (`LANG=MODULE[,CMD[,PARAM...]]`), and each SPEC occurrence MUST append one static-check entry under the canonical language key in `.req/config.json` key `"static-check"`.
- **SRS-249**: `--enable-static-check` MUST accept language names case-insensitively; the 20 valid canonical language names are: Python, C, C++, C#, Rust, JavaScript, TypeScript, Java, Go, Ruby, PHP, Swift, Kotlin, Scala, Lua, Shell, Perl, Haskell, Zig, Elixir; any unknown language name MUST produce a `ReqError` with exit code 1.
- **SRS-250**: `--enable-static-check` MUST accept a module name (case-insensitive) as the first comma-separated token after `=`: Dummy, Pylance, Ruff, or Command; for Command the second comma-separated token is the mandatory `cmd` binary; all subsequent comma-separated tokens are `params` stored as a JSON array, commas inside single-quoted or double-quoted tokens MUST NOT split parameters, and surrounding single or double quotes on each token MUST be stripped before persistence; unknown module names MUST produce a `ReqError` with exit code 1.
- **SRS-251**: When `--enable-static-check` is specified multiple times, all parsed entries MUST be preserved in insertion order; repeated language keys and repeated module names for the same language MUST NOT be deduplicated.
- **SRS-252**: When `--enable-static-check` is used during installation or update, `.req/config.json` key `"static-check"` MUST be a JSON object keyed by canonical language name, and each language value MUST be a non-empty JSON array of entry objects with required `"module"` and optional `"cmd"`/`"params"` fields.

### 5.4 Static Analysis Execution Commands
- **SRS-253**: The CLI MUST support `--files-static-check FILE [FILE ...]` as a standalone command (no `--base`/`--here` required); for each FILE it MUST resolve absolute path, detect language, load the language array from `"static-check"`, and execute all configured entries sequentially; files with no language or no configured entries MUST be skipped.
- **SRS-254**: When `--files-static-check` cannot locate `.req/config.json` (no `--here`, no `--base`, and no `.req/config.json` exists in CWD), the command MUST print a warning to stderr and exit with code 0 without checking any files.
- **SRS-255**: The `--files-static-check` command exit code MUST be 0 when all checked files pass (or no files are checked), and 1 when at least one file fails static analysis.
- **SRS-256**: The CLI MUST support `--static-check` as a project-scan command (requires `--base` or `--here`) using existing source-file collection rules; for each collected file it MUST detect language, load the language array from `"static-check"`, and execute all configured entries sequentially, skipping files with no configured entries.
- **SRS-257**: The `--static-check` command exit code MUST be 0 when all checked files pass (or no files are checked), and 1 when at least one file fails static analysis; it MUST be integrated into `cli.py` as a project-scan command dispatched via `_is_project_scan_command`.

### 5.5 Static Analysis Dispatch Implementation Requirements
- **SRS-258**: The implementation MUST provide a `STATIC_CHECK_LANG_CANONICAL` dict in `src/usereq/static_check.py` mapping lowercase language identifiers (including common aliases: `cpp` for C++, `csharp` for C#, `js` for JavaScript, `ts` for TypeScript, `sh` for Shell) to canonical language names from SRS-249.
- **SRS-259**: The implementation MUST provide a `STATIC_CHECK_EXT_TO_LANG` dict in `src/usereq/static_check.py` mapping file extensions to canonical language names, using the same 20-language extension set as SRS-131.
- **SRS-260**: The implementation MUST provide a `parse_enable_static_check(spec: str) -> tuple[str, dict]` function in `src/usereq/static_check.py` that: splits on the first `=`, validates the language (case-insensitive) and module (case-insensitive), tokenizes the right side as a comma-separated list to extract MODULE, optional `cmd` (for Command), and `params`, treats commas inside single-quoted or double-quoted tokens as literal characters, strips surrounding single or double quotes from each token, and returns `(canonical_lang, config_dict)`.
- **SRS-261**: The implementation MUST provide a `dispatch_static_check_for_file(filepath: str, lang_config: dict) -> int` function in `src/usereq/static_check.py` that: reads `module`, `cmd`, and `params` from `lang_config`; instantiates the appropriate checker class (`StaticCheckBase`, `StaticCheckPylance`, `StaticCheckRuff`, or `StaticCheckCommand`); and calls `run()` on a single-element file list.

### 5.6 Static Analysis Configuration and Dispatch Test Requirements
- **SRS-262**: The project MUST include unit tests in `tests/test_static_check.py` for parser/dispatcher behavior plus multi-entry language arrays, including repeated `Command` entries for one language and sequential execution checks for `--files-static-check` and `--static-check`.
