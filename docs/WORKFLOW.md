# Project Workflow Analysis

## CLI Execution Flow
- **Entry Point and Argument Handling**
    - `src/usereq/cli.py`
        - `main()`: Entry point for console_scripts and `-m` execution. [`src/usereq/cli.py`, 2006-2036]
            - description: Handles the primary entry point for the CLI, parsing arguments and delegating to specific run functions (upgrade, uninstall, remove, or main initialization). Catches and prints expected `ReqError`s and unexpected exceptions.
            - input: argv: list[str] | None, optional command line arguments
            - output: int, exit code (0 for success, non-zero for error)
            - calls:
                - `build_parser()`: Builds the CLI argument parser. [`src/usereq/cli.py`, 57-187]
                    - description: Constructs the `argparse.ArgumentParser` with all supported flags and arguments (e.g., --upgrade, --remove, --enable-*).
                    - input: None
                    - output: argparse.ArgumentParser, configured parser
                - `run_uninstall()`: Executes the uninstallation using uv. [`src/usereq/cli.py`, 234-250]
                    - description: Invokes `uv tool uninstall usereq` via subprocess to remove the tool.
                    - input: None
                    - output: None
                - `run_upgrade()`: Executes the upgrade using uv. [`src/usereq/cli.py`, 212-233]
                    - description: Invokes `uv tool install usereq --force --from ...` via subprocess to upgrade the tool.
                    - input: None
                    - output: None
                - `maybe_print_version()`: Checks for version flag and prints version. [`src/usereq/cli.py`, 204-210]
                    - description: Checks if --version is present in arguments and prints the package version if so.
                    - input: argv: list[str], command line arguments
                    - output: bool, True if version was printed
                - `parse_args()`: Parses command line arguments. [`src/usereq/cli.py`, 189-192]
                    - description: Uses the parser built by `build_parser` to parse the provided arguments into a Namespace.
                    - input: argv: list[str] | None, arguments to parse
                    - output: Namespace, parsed arguments
                - `run()`: Handles the main initialization flow. [`src/usereq/cli.py`, 1213-2036]
                    - description: Orchestrates the core logic: validates inputs, manages configuration, ensures directories, generates prompts, Codex skills, and agent files for enabled providers, and updates VSCode settings.
                    - input: args: Namespace, parsed command line arguments
                    - output: None
                    - calls:
                        - `run_remove()`: Handles the removal of generated resources. [`src/usereq/cli.py`, 1171-1210]
                            - description: Validates the project base and config, checks for newer versions, and removes generated resources and empty directories.
                            - input: args: Namespace, parsed arguments
                            - output: None
                            - calls:
                                - `remove_generated_resources()`: Removes generated files. [`src/usereq/cli.py`, 1131-1168]
                                    - description: Deletes files and directories generated by previous runs (e.g., .kiro, .codex, .codex/skills/req, requirements.md if from template).
                                    - input: project_base: Path, project root
                                    - output: None
                                - `prune_empty_dirs()`: Removes empty directories. [`src/usereq/cli.py`, 1118-1129]
                                    - description: Recursively removes empty directories within a given root.
                                    - input: root: Path, directory to prune
                                    - output: None
                        - `load_config()`: Loads configuration from .req/config.json. [`src/usereq/cli.py`, 486-524]
                            - description: Reads and parses the JSON configuration file, handling legacy formats and ensuring all required keys exist.
                            - input: project_base: Path, project root
                            - output: dict[str, str | list[str]], configuration dictionary
                        - `ensure_req_directory()`: Ensures requirement directory exists. [`src/usereq/cli.py`, 340-355]
                            - description: Checks if the requirements directory exists; calls `ensure_relative` to validate path safety.
                            - input: path: str, directory path; project_base: Path, project root
                            - output: None
                        - `ensure_doc_directory()`: Ensures documentation directory exists. [`src/usereq/cli.py`, 357-371]
                            - description: Checks if the documentation directory exists; calls `ensure_relative`.
                            - input: path: str, directory path; project_base: Path, project root
                            - output: None
                        - `ensure_test_directory()`: Ensures test directory exists. [`src/usereq/cli.py`, 373-387]
                            - description: Checks if the test directory exists; calls `ensure_relative`.
                            - input: path: str, directory path; project_base: Path, project root
                            - output: None
                        - `ensure_src_directory()`: Ensures source directory exists. [`src/usereq/cli.py`, 389-403]
                            - description: Checks if the source directory exists; calls `ensure_relative`.
                            - input: path: str, directory path; project_base: Path, project root
                            - output: None
                        - `make_relative_if_contains_project()`: Normalizes paths relative to project base. [`src/usereq/cli.py`, 405-429]
                            - description: Converts an absolute path to a relative path if it falls within the project base; otherwise returns the original.
                            - input: path_value: str, path to check; project_base: Path, project root
                            - output: str, relative or original path
                        - `copy_tech_templates()`: Copies technical templates. [`src/usereq/cli.py`, 623-660]
                            - description: Copies template files from the resources directory to the technical directory, handling overwrite logic.
                            - input: dest_dir: Path, destination directory; overwrite: bool, whether to overwrite existing files
                            - output: int, number of files copied
                        - `maybe_notify_newer_version()`: Checks for package updates. [`src/usereq/cli.py`, 298-338]
                            - description: Queries PyPI for the latest version and prints a notification if the current version is outdated.
                            - input: timeout_seconds: float, request timeout
                            - output: None
                        - `save_config()`: Saves configuration to .req/config.json. [`src/usereq/cli.py`, 463-484]
                            - description: Writes the current configuration (paths for req, tech, doc, test, src) to a JSON file.
                            - input: project_base: Path; req_dir: str; tech_dir: str; doc_dir: str; test_dir: str; src_dirs: list[str]
                            - output: None
                        - `find_template_source()`: Locates template source directory. [`src/usereq/cli.py`, 869-878]
                            - description: Resolves the path to the 'templates' directory within the package resources.
                            - input: None
                            - output: Path, path to templates
                        - `generate_req_file_list()`: Generates file list for REQ_DIR token. [`src/usereq/cli.py`, 526-542]
                            - description: Scans the requirements directory and creates a formatted list of files for template substitution.
                            - input: req_dir: Path; project_base: Path
                            - output: str, formatted file list
                        - `generate_tech_file_list()`: Generates file list for TECH_DIR token. [`src/usereq/cli.py`, 565-590]
                            - description: Scans the technical directory and creates a formatted list of files.
                            - input: tech_dir: Path; project_base: Path
                            - output: str, formatted file list
                        - `load_kiro_template()`: Loads Kiro agent template. [`src/usereq/cli.py`, 880-912]
                            - description: Reads the Kiro JSON template and configuration from resources.
                            - input: None
                            - output: tuple[str, dict], template string and config dict
                        - `load_centralized_models()`: Loads model configurations. [`src/usereq/cli.py`, 945-994]
                            - description: Loads and merges model definitions from centralized JSON files, supporting legacy and user overrides.
                            - input: resource_root: Path; legacy_mode: bool; preserve_models_path: Path | None
                            - output: dict, merged model configuration
                        - `extract_frontmatter()`: Extracts frontmatter from prompt files. [`src/usereq/cli.py`, 742-749]
                            - description: Splits the prompt file content into YAML frontmatter and the body.
                            - input: content: str
                            - output: tuple[str, str], frontmatter and body
                        - `apply_replacements()`: Applies token replacements. [`src/usereq/cli.py`, 682-687]
                            - description: Replaces placeholders (e.g., %%REQ_DIR%%) in text with actual values.
                            - input: text: str; replacements: Mapping[str, str]
                            - output: str, text with replacements applied
                        - `write_text_file()`: Writes text to a file. [`src/usereq/cli.py`, 689-693]
                            - description: Writes string content to a destination path using UTF-8 encoding.
                            - input: dst: Path; text: str
                            - output: None
                        - `md_to_toml()`: Converts Markdown prompt to TOML. [`src/usereq/cli.py`, 714-740]
                            - description: Converts a Markdown prompt file to a TOML format suitable for Gemini commands.
                            - input: md_path: Path; toml_path: Path; force: bool
                            - output: None
                        - `generate_kiro_resources()`: Generates Kiro resource list. [`src/usereq/cli.py`, 792-812]
                            - description: Creates a list of resource objects for Kiro agents, including local files and the prompt.
                            - input: req_dir: Path; project_base: Path; prompt_rel_path: str
                            - output: list[dict], list of resources
                        - `render_kiro_agent()`: Renders Kiro agent JSON. [`src/usereq/cli.py`, 814-854]
                            - description: Populates the Kiro agent JSON template with name, description, prompt, tools, and model.
                            - input: template: str; name: str; description: str; prompt: str; resources: list; tools: list; model: str; include_tools: bool; include_model: bool
                            - output: str, rendered JSON
                        - `find_vscode_settings_source()`: Locates VSCode settings template. [`src/usereq/cli.py`, 1071-1077]
                            - description: Resolves the path to the 'vscode/settings.json' template.
                            - input: None
                            - output: Path | None, path to settings or None
                        - `load_settings()`: Loads JSON settings with comment stripping. [`src/usereq/cli.py`, 934-943]
                            - description: Reads a JSON file, strips comments, and parses it into a dictionary.
                            - input: path: Path
                            - output: dict, parsed settings
                        - `deep_merge_dict()`: Merges two dictionaries recursively. [`src/usereq/cli.py`, 1061-1069]
                            - description: Deeply merges an incoming dictionary into a base dictionary.
                            - input: base: dict; incoming: dict
                            - output: dict, merged dictionary
                        - `save_vscode_backup()`: Backs up VSCode settings. [`src/usereq/cli.py`, 1098-1105]
                            - description: Copies the existing VSCode settings.json to a backup file in the .req directory.
                            - input: req_root: Path; settings_path: Path
                            - output: None

## Documentation Utilities
- **PDoc Generation**
    - `src/usereq/pdoc_utils.py`
        - `generate_pdoc_docs()`: Generates API documentation using pdoc. [`src/usereq/pdoc_utils.py`, 31-84]
            - description: Runs the `pdoc` module as a subprocess to generate HTML documentation for the specified modules. Handles environment setup and arguments.
            - input: output_dir: Path, target directory; modules: Sequence[str] | str, modules to document; all_submodules: bool, recursion flag
            - output: None
            - calls:
                - `_normalize_modules()`: Normalizes module input. [`src/usereq/pdoc_utils.py`, 12-16]
                    - description: Converts a single string module name or an iterable of names into a list of strings.
                    - input: modules: str | Iterable[str]
                    - output: list[str], list of module names
                - `_run_pdoc()`: Executes the pdoc command. [`src/usereq/pdoc_utils.py`, 19-28]
                    - description: Wrapper around `subprocess.run` to execute pdoc with the constructed command and environment.
                    - input: command: list[str]; env: dict; cwd: Path
                    - output: subprocess.CompletedProcess
