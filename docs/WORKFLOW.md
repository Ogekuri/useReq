# WORKFLOW CALL TREE (Evidence-Based)

- Feature: CLI entrypoint dispatch and mode selection
  - Module: `usereq.cli` (`src/usereq/cli.py`)
    - `main()`: Route CLI invocation into uninstall/upgrade/version/standalone/project/init flows [`src/usereq/cli.py:L2141-L2192`]
      - description: Parses argv source, executes high-priority direct commands (`--uninstall`, `--upgrade`, version), then parsed-mode routing through `_is_standalone_command()`, `_is_project_scan_command()`, and `run()`. Converts `ReqError` to stderr+exit code; unknown exceptions return `1`.
      - `maybe_print_version()`: Print package version and short-circuit [`src/usereq/cli.py:L230-L235`]
        - description: Detects `--ver|--version`, calls `load_package_version()`, writes to stdout, returns boolean gate.
      - `parse_args()`: Build and execute argparse parser [`src/usereq/cli.py:L215-L217`]
        - description: Delegates parser creation to `build_parser()` and returns Namespace.
      - `_is_standalone_command()`: Detect direct file-list commands [`src/usereq/cli.py:L2032-L2038`]
        - description: Returns boolean for `--files-tokens|--files-references|--files-compress`.
      - `_is_project_scan_command()`: Detect project directory scan commands [`src/usereq/cli.py:L2041-L2046`]
        - description: Returns boolean for `--references|--compress`.

- Feature: Initialization and resource generation
  - Module: `usereq.cli` (`src/usereq/cli.py`)
    - `run()`: Execute validated initialization workflow [`src/usereq/cli.py:L1186-L1989`]
      - description: Validates base/config/paths/providers, persists config, computes token substitutions, creates provider-specific assets, copies templates, merges VSCode settings, and prints installation summary.
      - `load_config()`: Load persisted `.req/config.json` for update-mode [`src/usereq/cli.py:L502-L536`]
        - description: Reads JSON config, supports legacy key aliases (`doc-dir`,`test-dir`), validates required fields and types.
      - `ensure_doc_directory()` / `ensure_test_directory()` / `ensure_src_directory()`: Validate required project directories [`src/usereq/cli.py:L366-L412`]
        - description: Normalize path via `make_relative_if_contains_project()`, assert location under project base, existence, and directory type.
      - `make_relative_if_contains_project()`: Normalize user path to project-relative value [`src/usereq/cli.py:L414-L447`]
        - description: Handles absolute paths, duplicated base-name segments, and canonical relative-path conversion.
      - `save_config()`: Persist normalized dirs in `.req/config.json` [`src/usereq/cli.py:L481-L500`]
        - description: Performs filesystem write (`mkdir`, JSON serialization, write_text) for future `--update` and project-scan commands.
      - `maybe_notify_newer_version()`: Fetch latest release metadata [`src/usereq/cli.py:L324-L364`]
        - description: External HTTP GET to GitHub Releases API (`https://api.github.com/repos/Ogekuri/useReq/releases/latest`), compares normalized semantic tuples, conditionally prints upgrade notice.
      - `find_template_source()`: Resolve packaged requirements template root [`src/usereq/cli.py:L843-L851`]
        - description: Asserts resource presence (`resources/templates/requirements.md`) before copy stage.
      - `generate_guidelines_file_list()` / `generate_guidelines_file_items()`: Compute guideline-token payloads [`src/usereq/cli.py:L539-L594`]
        - description: Enumerates non-hidden files in technical directory, emits normalized forward-slash relative paths for replacement/reporting.
      - `load_kiro_template()`: Load Kiro template/model metadata [`src/usereq/cli.py:L854-L885`]
        - description: Reads centralized model files (`models.json` fallback `models-legacy.json`) through `load_settings()` and extracts `kiro.agent_template`.
      - `load_centralized_models()`: Load provider prompt metadata [`src/usereq/cli.py:L919-L968`]
        - description: Selects models source (`preserve` > `legacy` > default), parses JSON/JSONC, returns provider map (`claude`,`copilot`,`opencode`,`kiro`,`gemini`,`codex`).
      - `extract_frontmatter()` + `extract_description()` + `extract_argument_hint()`: Parse prompt metadata [`src/usereq/cli.py:L716-L738`]
        - description: Regex-splits frontmatter/body and extracts fields used by all provider writers.
      - `apply_replacements()`: Replace prompt placeholders with runtime paths [`src/usereq/cli.py:L656-L660`]
        - description: Applies token substitution map (`%%GUIDELINES_FILES%%`, `%%DOC_PATH%%`, `%%TEST_PATH%%`, `%%SRC_PATHS%%`, `%%ARGS%%`).
      - `md_to_toml()` + `replace_tokens()`: Build Gemini command artifacts [`src/usereq/cli.py:L688-L713`, `src/usereq/cli.py:L830-L835`]
        - description: Converts markdown prompt into TOML body and performs provider-specific token post-processing writes.
      - `render_kiro_agent()` + `generate_kiro_resources()`: Build Kiro agent JSON [`src/usereq/cli.py:L788-L825`, `src/usereq/cli.py:L766-L785`]
        - description: Injects template fields/resources/tools/model and serializes JSON payload for `.kiro/agents`.
      - `get_model_tools_for_prompt()` / `get_raw_tools_for_prompt()` / `format_tools_inline_list()`: Resolve model/tool fields [`src/usereq/cli.py:L970-L1032`]
        - description: Maps prompt mode->usage mode->tools/model; normalizes list/string variants for provider headers.
      - `write_text_file()`: Provider output sink [`src/usereq/cli.py:L663-L667`]
        - description: Central file-write helper used for generated prompt/agent files (`mkdir -p`, UTF-8 write).
      - `find_vscode_settings_source()` + `load_settings()` + `deep_merge_dict()` + `save_vscode_backup()`: Merge editor settings [`src/usereq/cli.py:L1045-L1050`, `src/usereq/cli.py:L908-L917`, `src/usereq/cli.py:L1035-L1042`, `src/usereq/cli.py:L1072-L1079`]
        - description: Loads template and existing settings, strips JSON comments when needed, deep-merges dictionaries, creates backup before overwrite.

- Feature: Removal workflow
  - Module: `usereq.cli` (`src/usereq/cli.py`)
    - `run_remove()`: Validate and execute cleanup mode [`src/usereq/cli.py:L1145-L1184`]
      - description: Rejects incompatible args, validates project/config existence, optionally checks remote version, executes generated-resource deletion, prunes empty provider directories.
      - `remove_generated_resources()`: Delete generated assets under project root [`src/usereq/cli.py:L1105-L1142`]
        - description: Removes provider directories/files (`.gemini/.claude/.codex/.github/.kiro/.opencode/.req`) with safety guard `ensure_wrapped()`.
      - `prune_empty_dirs()`: Remove empty directory shells [`src/usereq/cli.py:L1092-L1102`]
        - description: Bottom-up walk and `rmdir` cleanup for now-empty provider paths.

- Feature: Standalone and project-wide source processing commands
  - Module: `usereq.cli` + helper modules
    - `run_files_tokens()`: Count tokens/chars for explicit file list [`src/usereq/cli.py:L2049-L2064`]
      - description: Validates existence list then delegates to token metrics pipeline and prints formatted summary.
      - `count_files_metrics()` -> `TokenCounter.count_tokens()` / `TokenCounter.count_chars()` [`src/usereq/token_counter.py:L45-L70`, `src/usereq/token_counter.py:L19-L29`]
        - description: Reads each file, computes token count via `tiktoken` encoding and character count, emits per-file records/errors.
      - `format_pack_summary()`: Build textual totals [`src/usereq/token_counter.py:L73-L105`]
        - description: Aggregates totals and renders per-file + global summary lines.
    - `run_files_references()`: Produce markdown references for explicit file list [`src/usereq/cli.py:L2067-L2072`]
      - description: Delegates to `generate_markdown()` and prints aggregated markdown payload.
      - `generate_markdown()`: Analyze+enrich+render each file [`src/usereq/generate_markdown.py:L55-L108`]
        - description: For each valid file, detect language, call `SourceAnalyzer.analyze()`, `SourceAnalyzer.enrich()`, and `format_markdown()` then concatenate with separators.
    - `run_files_compress()`: Compress explicit file list [`src/usereq/cli.py:L2075-L2080`]
      - description: Delegates to `compress_files()` and prints concatenated compressed payload.
      - `compress_files()` -> `compress_file()` -> `compress_source()` [`src/usereq/compress_files.py:L24-L72`, `src/usereq/compress.py:L320-L343`, `src/usereq/compress.py:L148-L317`]
        - description: Detects language per file, reads source, removes comments/blank lines/extra whitespace while preserving indentation-sensitive languages, emits `@@@ path | lang` segments.
    - `run_references()` / `run_compress_cmd()`: Project-src directory variants [`src/usereq/cli.py:L2083-L2104`]
      - description: Resolve project source dirs through `_resolve_project_src_dirs()`, collect files through `_collect_source_files()`, then reuse standalone generation/compression pipelines.
      - `_resolve_project_src_dirs()`: Resolve base and source dirs from args or persisted config [`src/usereq/cli.py:L2107-L2138`]
        - description: Enforces `--base|--here`, loads `.req/config.json` fallback, validates source-dir availability.
      - `_collect_source_files()`: Recursive collection with extension+directory filters [`src/usereq/cli.py:L2010-L2029`]
        - description: Filesystem traversal excludes cache/build/vendor dirs and includes only predefined source extensions.

- Feature: Source structure analyzer engine
  - Module: `usereq.source_analyzer` (`src/usereq/source_analyzer.py`)
    - `build_language_specs()`: Build regex-based recognition catalog [`src/usereq/source_analyzer.py:L117-L667`]
      - description: Defines language-specific comment delimiters, string delimiters, and construct regexes for 20 languages + aliases.
    - `SourceAnalyzer.analyze()`: Parse source into typed elements [`src/usereq/source_analyzer.py:L690-L836`]
      - description: Reads file lines, tracks multiline comments, detects inline/full comments using `_find_comment()`, matches definitions against language patterns, computes block ranges via `_find_block_end()`, emits `SourceElement` list.
      - `_in_string_context()`: Guard against false comment markers inside strings [`src/usereq/source_analyzer.py:L838-L865`]
        - description: Stateful delimiter scan used by comment and multiline detection logic.
      - `_find_comment()`: Detect single-line comment index outside strings [`src/usereq/source_analyzer.py:L867-L899`]
        - description: Iterates with string-state tracking and returns first valid comment-marker offset.
      - `_find_block_end()`: Heuristic block boundary resolver [`src/usereq/source_analyzer.py:L901-L975`]
        - description: Uses indentation/brace/end-keyword strategies per language family to assign `line_end` ranges.
    - `SourceAnalyzer.enrich()`: Add semantic metadata to parsed elements [`src/usereq/source_analyzer.py:L979-L995`]
      - description: Sequentially executes normalization, signature extraction, hierarchy linking, visibility derivation, inheritance parsing, and optional body annotation extraction.
      - `_extract_body_annotations()`: Gather in-body comments and exit points [`src/usereq/source_analyzer.py:L1181-L1310`]
        - description: Re-reads source, scans element body lines, captures cleaned comment snippets and control-flow exits (`return`,`raise`,`throw`,`panic!`,`sys.exit`).
    - `format_markdown()`: Render LLM-oriented file synopsis [`src/usereq/source_analyzer.py:L1642-L1894`]
      - description: Produces deterministic markdown sections (header/imports/definitions/comments/symbol-index), attaches doc-comment adjacency from `_build_comment_maps()`, and inserts body annotations via `_render_body_annotations()`.

- Feature: Auxiliary modules and packaging entrypoints
  - Module: `usereq.__main__`, `usereq.__init__`, `usereq.pdoc_utils`
    - `__main__` module execution -> `cli.main()` [`src/usereq/__main__.py:L1-L7`]
      - description: Python module entrypoint returning CLI exit code.
    - `generate_pdoc_docs()`: API documentation generation wrapper [`src/usereq/pdoc_utils.py:L31-L84`]
      - description: Builds pdoc subprocess command, prepares `PYTHONPATH`, runs `_run_pdoc()`, retries without `--all-submodules` on compatibility failure, raises RuntimeError on non-zero exit.
      - `_run_pdoc()`: subprocess execution wrapper [`src/usereq/pdoc_utils.py:L19-L28`]
        - description: Executes command with captured output to support explicit error handling.

- Feature: CI/CD release workflow
  - Module: GitHub Actions workflow (`.github/workflows/release-uvx.yml`)
    - `build-release` job: Build and publish release artifacts [`/.github/workflows/release-uvx.yml:L13-L48`]
      - description: On version tag push, checks out repository, sets Python+uv, installs build deps, runs `python -m build`, creates provenance attestation, uploads `dist/*` to GitHub Release.

- Cross-cutting operational evidence
  - File-system write operations (non-exhaustive, direct evidence)
    - `save_config()` writes `.req/config.json` [`src/usereq/cli.py:L489-L499`]
    - `write_text_file()` writes generated prompt/agent files [`src/usereq/cli.py:L663-L667`]
    - `md_to_toml()` writes Gemini TOML files [`src/usereq/cli.py:L711-L713`]
    - `replace_tokens()` rewrites TOML content [`src/usereq/cli.py:L830-L835`]
    - `remove_generated_resources()` deletes generated trees/files [`src/usereq/cli.py:L1105-L1142`]
    - `compress_file()` and `generate_markdown()` perform source reads [`src/usereq/compress.py:L339-L340`, `src/usereq/generate_markdown.py:L88-L89`]
  - External API/network access
    - `maybe_notify_newer_version()` -> GitHub Releases API via `urllib.request.urlopen` [`src/usereq/cli.py:L324-L364`]
  - External process execution
    - `run_upgrade()` / `run_uninstall()` use `uv tool ...` via `subprocess.run` [`src/usereq/cli.py:L238-L276`]
    - `generate_pdoc_docs()` uses `python -m pdoc` via `subprocess.run` [`src/usereq/pdoc_utils.py:L19-L28`, `src/usereq/pdoc_utils.py:L57-L83`]
  - External database access
    - No database client initialization, connection string, SQL execution, or ORM session detected in `src/usereq/*.py`.
  - Common reusable logic
    - Path normalization and safety (`make_relative_if_contains_project()`, `ensure_relative()`, `ensure_wrapped()`) centralize path trust boundaries [`src/usereq/cli.py:L414-L447`, `src/usereq/cli.py:L647-L653`, `src/usereq/cli.py:L1063-L1069`]
    - Token substitution abstraction (`apply_replacements()`, `replace_tokens()`) reused across provider output targets [`src/usereq/cli.py:L656-L660`, `src/usereq/cli.py:L830-L835`]
