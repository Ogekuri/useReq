# Workflow

- CLI entry and command dispatch
  - Module: `src/usereq/__main__.py`
    - `main()`: Delegates to `cli.main()` and exits with its return code [src/usereq/__main__.py, 1-7]
  - Module: `src/usereq/cli.py`
    - `main()`: Parses arguments and routes to upgrade/uninstall/run flows [src/usereq/cli.py, 1928-1958]
      - `build_parser()`: Defines CLI flags and options for help output [src/usereq/cli.py, 57-181]
      - `parse_args()`: Parses argv into a Namespace [src/usereq/cli.py, 184-186]
      - `maybe_print_version()`: Prints version-only output when requested [src/usereq/cli.py, 199-204]
        - `load_package_version()`: Loads the package version string [src/usereq/cli.py, 189-196]
      - `run_upgrade()`: Executes `uv tool install` via subprocess [src/usereq/cli.py, 207-226]
      - `run_uninstall()`: Executes `uv tool uninstall` via subprocess [src/usereq/cli.py, 229-245]
      - `run()`: Orchestrates install/update/remove workflows [src/usereq/cli.py, 1180-1925]

- Version check and release parsing
  - Module: `src/usereq/cli.py`
    - `maybe_notify_newer_version()`: Performs HTTP GET to GitHub API, compares versions, prints notice (external API; no database access) [src/usereq/cli.py, 293-332]
      - `normalize_release_tag()`: Normalizes release tags for version parsing [src/usereq/cli.py, 248-253]
      - `parse_version_tuple()`: Parses version strings into tuples [src/usereq/cli.py, 256-277]
      - `is_newer_version()`: Compares current and latest versions [src/usereq/cli.py, 280-290]

- Removal workflow (--remove)
  - Module: `src/usereq/cli.py`
    - `run_remove()`: Validates inputs, checks config, triggers version check, removes resources [src/usereq/cli.py, 1139-1177]
      - `maybe_notify_newer_version()`: Performs release check before removal [src/usereq/cli.py, 293-332]
      - `remove_generated_resources()`: Deletes generated files/directories from project [src/usereq/cli.py, 1100-1136]
        - `ensure_wrapped()`: Verifies removal targets are under the project root [src/usereq/cli.py, 1058-1064]
      - `prune_empty_dirs()`: Removes empty directories after cleanup [src/usereq/cli.py, 1087-1097]

- Installation and update workflow (all providers enabled)
  - Module: `src/usereq/cli.py`
    - `run()`: Validates inputs, prepares paths/config, generates prompts/resources, merges settings, prints report [src/usereq/cli.py, 1180-1925]
      - `load_config()`: Reads `.req/config.json` during updates [src/usereq/cli.py, 463-492]
      - `ensure_req_directory()`: Validates requirements directory exists [src/usereq/cli.py, 335-349]
      - `ensure_doc_directory()`: Validates documentation directory exists [src/usereq/cli.py, 352-365]
      - `ensure_test_directory()`: Validates test directory exists [src/usereq/cli.py, 368-381]
      - `make_relative_if_contains_project()`: Normalizes paths relative to project base [src/usereq/cli.py, 384-407]
      - `ensure_relative()`: Enforces relative path semantics [src/usereq/cli.py, 642-648]
      - `resolve_absolute()`: Resolves normalized paths to absolute [src/usereq/cli.py, 410-417]
      - `compute_sub_path()`: Computes substitution paths for tokens [src/usereq/cli.py, 427-439]
        - `format_substituted_path()`: Normalizes substitution formatting [src/usereq/cli.py, 420-424]
      - `make_relative_token()`: Formats token values with optional trailing slash [src/usereq/cli.py, 631-639]
      - `save_config()`: Writes `.req/config.json` to disk [src/usereq/cli.py, 442-460]
      - `copy_tech_templates()`: Copies tech templates into --tech-dir (filesystem write) [src/usereq/cli.py, 592-628]
      - `find_template_source()`: Locates packaged template directory [src/usereq/cli.py, 838-846]
      - `generate_req_file_list()`: Builds %%REQ_DIR%% list, skipping dotfiles [src/usereq/cli.py, 495-510]
      - `generate_tech_file_list()`: Builds %%TECH_DIR%% list, skipping dotfiles with fallback [src/usereq/cli.py, 534-558]
      - `load_kiro_template()`: Loads Kiro agent template and config [src/usereq/cli.py, 849-880]
      - `load_centralized_models()`: Loads models.json/models-legacy.json from disk [src/usereq/cli.py, 914-962]
      - `extract_frontmatter()`: Splits front matter from prompt body [src/usereq/cli.py, 711-717]
      - `extract_description()`: Extracts normalized description from front matter [src/usereq/cli.py, 720-725]
        - `normalize_description()`: Sanitizes description whitespace [src/usereq/cli.py, 673-680]
      - `extract_argument_hint()`: Extracts normalized argument hint [src/usereq/cli.py, 728-733]
        - `normalize_description()`: Sanitizes argument hint whitespace [src/usereq/cli.py, 673-680]
      - `apply_replacements()`: Substitutes tokens in prompt text [src/usereq/cli.py, 651-655]
      - `yaml_double_quote_escape()`: Escapes YAML string values [src/usereq/cli.py, 833-835]
      - `get_model_tools_for_prompt()`: Retrieves model/tools configuration per prompt [src/usereq/cli.py, 965-999]
      - `get_raw_tools_for_prompt()`: Reads raw tools value from config [src/usereq/cli.py, 1002-1020]
      - `format_tools_inline_list()`: Formats tools list for configuration files [src/usereq/cli.py, 1023-1027]
      - `write_text_file()`: Writes generated text files to disk [src/usereq/cli.py, 658-661]
      - `md_to_toml()`: Converts Markdown prompts to TOML files (filesystem write) [src/usereq/cli.py, 683-708]
      - `replace_tokens()`: Replaces tokens inside TOML files [src/usereq/cli.py, 825-830]
      - `generate_kiro_resources()`: Builds Kiro resources list with JSON-escaped paths [src/usereq/cli.py, 761-780]
        - `json_escape()`: Escapes strings for JSON output [src/usereq/cli.py, 756-758]
      - `render_kiro_agent()`: Renders Kiro agent JSON content [src/usereq/cli.py, 783-822]
        - `json_escape()`: Escapes strings for JSON output [src/usereq/cli.py, 756-758]
      - `find_vscode_settings_source()`: Locates VS Code settings template [src/usereq/cli.py, 1040-1045]
      - `load_settings()`: Loads JSON/JSONC settings from disk [src/usereq/cli.py, 903-911]
        - `strip_json_comments()`: Removes JSONC comments [src/usereq/cli.py, 883-900]
      - `deep_merge_dict()`: Recursively merges settings dictionaries [src/usereq/cli.py, 1030-1037]
      - `build_prompt_recommendations()`: Builds prompt recommendation map [src/usereq/cli.py, 1048-1055]
      - `save_vscode_backup()`: Writes backup of settings.json [src/usereq/cli.py, 1067-1073]
      - `generate_req_file_items()`: Builds %%REQ_DIR%% print list (no formatting) [src/usereq/cli.py, 513-531]
      - `generate_tech_file_items()`: Builds %%TECH_DIR%% print list (no formatting) [src/usereq/cli.py, 561-589]
      - `_format_install_table()`: Formats ASCII summary table [src/usereq/cli.py, 1888-1917]

- Common logging utilities
  - Module: `src/usereq/cli.py`
    - `log()`: Writes standard log messages to stdout [src/usereq/cli.py, 40-42]
    - `dlog()`: Writes debug messages when DEBUG is enabled [src/usereq/cli.py, 45-48]
    - `vlog()`: Writes verbose messages when VERBOSE is enabled [src/usereq/cli.py, 51-54]

- Documentation generation
  - Module: `src/usereq/pdoc_utils.py`
    - `generate_pdoc_docs()`: Generates HTML documentation via pdoc (filesystem + subprocess) [src/usereq/pdoc_utils.py, 31-83]
      - `_normalize_modules()`: Normalizes module list input [src/usereq/pdoc_utils.py, 12-16]
      - `_run_pdoc()`: Executes pdoc subprocess with env/cwd [src/usereq/pdoc_utils.py, 19-28]
