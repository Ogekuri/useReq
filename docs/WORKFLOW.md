# Project Workflow Analysis

## CLI Execution Flow
- **Entry Point and Argument Handling**
    - `src/usereq/cli.py`
        - `main()`: Entry point for console_scripts and `-m` execution. [`src/usereq/cli.py`, 1949-1979]
            - description: Handles the primary entry point for the CLI, parsing arguments and delegating to specific run functions (upgrade, uninstall, remove, or main initialization). Catches and prints expected `ReqError`s and unexpected exceptions.
            - input: argv: list[str] | None, optional command line arguments
            - output: int, exit code (0 for success, non-zero for error)
            - calls:
                - `build_parser()`: Builds the CLI argument parser. [`src/usereq/cli.py`, 57-187]
                    - description: Constructs the `argparse.ArgumentParser` with all supported flags and arguments (e.g., --docs-dir, --tests-dir, --add-guidelines, --copy-guidelines, --upgrade, --remove, --enable-*).
                    - input: None
                    - output: argparse.ArgumentParser, configured parser
                - `run_uninstall()`: Executes the uninstallation using uv. [`src/usereq/cli.py`, 234-250]
                    - description: Invokes `uv tool uninstall usereq` via subprocess to remove the tool.
                    - input: None
                    - output: None
                - `run_upgrade()`: Executes the upgrade using uv. [`src/usereq/cli.py`, 212-233]
                    - description: Invokes `uv tool install usereq --force --from ...` via subprocess to upgrade the tool.
                    - input: None
                    - output: None
                - `maybe_print_version()`: Checks for version flag and prints version. [`src/usereq/cli.py`, 204-210]
                    - description: Checks if --version is present in arguments and prints the package version if so.
                    - input: argv: list[str], command line arguments
                    - output: bool, True if version was printed
                - `parse_args()`: Parses command line arguments. [`src/usereq/cli.py`, 189-192]
                    - description: Uses the parser built by `build_parser` to parse the provided arguments into a Namespace.
                    - input: argv: list[str] | None, arguments to parse
                    - output: Namespace, parsed arguments
                - `run()`: Handles the main initialization flow. [`src/usereq/cli.py`, 1155-1959]
                    - description: Orchestrates the core logic: validates inputs, manages configuration, ensures directories, generates prompts, Codex skills, and agent files for enabled providers, and updates VSCode settings.
                    - input: args: Namespace, parsed command line arguments
                    - output: None
                    - calls:
                        - `run_remove()`: Handles the removal of generated resources. [`src/usereq/cli.py`, 1105-1143]
                            - description: Validates the project base and config, checks for newer versions, and removes generated resources and empty directories.
                            - input: args: Namespace, parsed arguments
                            - output: None
                            - calls:
                                - `remove_generated_resources()`: Removes generated files. [`src/usereq/cli.py`, 1065-1102]
                                    - description: Deletes files and directories generated by previous runs (e.g., .kiro, .codex, .codex/skills/req, requirements.md if from template).
                                    - input: project_base: Path, project root
                                    - output: None
                                - `prune_empty_dirs()`: Removes empty directories. [`src/usereq/cli.py`, 1052-1063]
                                    - description: Recursively removes empty directories within a given root.
                                    - input: root: Path, directory to prune
                                    - output: None
                        - `load_config()`: Loads configuration from .req/config.json. [`src/usereq/cli.py`, 472-506]
                            - description: Reads and parses the JSON configuration file, handling legacy formats and ensuring all required keys exist.
                            - input: project_base: Path, project root
                            - output: dict[str, str | list[str]], configuration dictionary
                        - `ensure_doc_directory()`: Ensures documentation directory exists. [`src/usereq/cli.py`, 336-350]
                            - description: Checks if the documentation directory exists; calls `ensure_relative`.
                            - input: path: str, directory path; project_base: Path, project root
                            - output: None
                        - `ensure_test_directory()`: Ensures test directory exists. [`src/usereq/cli.py`, 352-366]
                            - description: Checks if the test directory exists; calls `ensure_relative`.
                            - input: path: str, directory path; project_base: Path, project root
                            - output: None
                        - `ensure_src_directory()`: Ensures source directory exists. [`src/usereq/cli.py`, 368-382]
                            - description: Checks if the source directory exists; calls `ensure_relative`.
                            - input: path: str, directory path; project_base: Path, project root
                            - output: None
                        - `make_relative_if_contains_project()`: Normalizes paths relative to project base. [`src/usereq/cli.py`, 384-417]
                            - description: Converts absolute paths under project base to relative values and trims duplicated `--base` path segments from relative inputs before validation.
                            - input: path_value: str, path to check; project_base: Path, project root
                            - output: str, relative or original path
                        - `copy_guidelines_templates()`: Copies technical templates. [`src/usereq/cli.py`, 566-594]
                            - description: Copies template files from the resources directory to the technical directory, triggered by --add-guidelines/--copy-guidelines and handling overwrite logic.
                            - input: dest_dir: Path, destination directory; overwrite: bool, whether to overwrite existing files
                            - output: int, number of files copied
                        - `maybe_notify_newer_version()`: Checks for package updates. [`src/usereq/cli.py`, 294-334]
                            - description: Queries PyPI for the latest version and prints a notification if the current version is outdated.
                            - input: timeout_seconds: float, request timeout
                            - output: None
                        - `save_config()`: Saves configuration to .req/config.json. [`src/usereq/cli.py`, 451-470]
                            - description: Writes the current configuration (paths for guidelines, doc, test, src) to a JSON file.
                            - input: project_base: Path; guidelines_dir: str; doc_dir: str; test_dir: str; src_dirs: list[str]
                            - output: None
                        - `find_template_source()`: Locates template source directory. [`src/usereq/cli.py`, 812-821]
                            - description: Resolves the path to the 'templates' directory within the package resources.
                            - input: None
                            - output: Path, path to templates
                        - `generate_guidelines_file_list()`: Generates file list for GUIDELINES_FILES token. [`src/usereq/cli.py`, 508-533]
                            - description: Scans the technical directory and creates a formatted list of files.
                            - input: guidelines_dir: Path; project_base: Path
                            - output: str, formatted file list
                        - `load_kiro_template()`: Loads Kiro agent template. [`src/usereq/cli.py`, 823-855]
                            - description: Reads the Kiro JSON template and configuration from resources.
                            - input: None
                            - output: tuple[str, dict], template string and config dict
                        - `load_centralized_models()`: Loads model configurations. [`src/usereq/cli.py`, 888-937]
                            - description: Loads and merges model definitions from centralized JSON files, supporting legacy and user overrides.
                            - input: resource_root: Path; legacy_mode: bool; preserve_models_path: Path | None
                            - output: dict, merged model configuration
                        - `extract_frontmatter()`: Extracts frontmatter from prompt files. [`src/usereq/cli.py`, 685-692]
                            - description: Splits the prompt file content into YAML frontmatter and the body.
                            - input: content: str
                            - output: tuple[str, str], frontmatter and body
                        - `apply_replacements()`: Applies token replacements. [`src/usereq/cli.py`, 625-630]
                            - description: Replaces placeholders in text with actual values from the provided mapping.
                            - input: text: str; replacements: Mapping[str, str]
                            - output: str, text with replacements applied
                        - `write_text_file()`: Writes text to a file. [`src/usereq/cli.py`, 632-636]
                            - description: Writes string content to a destination path using UTF-8 encoding.
                            - input: dst: Path; text: str
                            - output: None
                        - `md_to_toml()`: Converts Markdown prompt to TOML. [`src/usereq/cli.py`, 657-683]
                            - description: Converts a Markdown prompt file to a TOML format suitable for Gemini commands.
                            - input: md_path: Path; toml_path: Path; force: bool
                            - output: None
                        - `generate_kiro_resources()`: Generates Kiro resource list. [`src/usereq/cli.py`, 735-755]
                            - description: Creates a list of resource objects for Kiro agents, including local files and the prompt.
                            - input: req_dir: Path; project_base: Path; prompt_rel_path: str
                            - output: list[dict], list of resources
                        - `render_kiro_agent()`: Renders Kiro agent JSON. [`src/usereq/cli.py`, 757-797]
                            - description: Populates the Kiro agent JSON template with name, description, prompt, tools, and model.
                            - input: template: str; name: str; description: str; prompt: str; resources: list; tools: list; model: str; include_tools: bool; include_model: bool
                            - output: str, rendered JSON
                        - `find_vscode_settings_source()`: Locates VSCode settings template. [`src/usereq/cli.py`, 1014-1020]
                            - description: Resolves the path to the 'vscode/settings.json' template.
                            - input: None
                            - output: Path | None, path to settings or None
                        - `load_settings()`: Loads JSON settings with comment stripping. [`src/usereq/cli.py`, 877-886]
                            - description: Reads a JSON file, strips comments, and parses it into a dictionary.
                            - input: path: Path
                            - output: dict, parsed settings
                        - `deep_merge_dict()`: Merges two dictionaries recursively. [`src/usereq/cli.py`, 1004-1012]
                            - description: Deeply merges an incoming dictionary into a base dictionary.
                            - input: base: dict; incoming: dict
                            - output: dict, merged dictionary
                        - `save_vscode_backup()`: Backs up VSCode settings. [`src/usereq/cli.py`, 1041-1048]
                            - description: Copies the existing VSCode settings.json to a backup file in the .req directory.
                            - input: req_root: Path; settings_path: Path
                            - output: None

## Documentation Utilities
- **PDoc Generation**
    - `src/usereq/pdoc_utils.py`
        - `generate_pdoc_docs()`: Generates API documentation using pdoc. [`src/usereq/pdoc_utils.py`, 31-84]
            - description: Runs the `pdoc` module as a subprocess to generate HTML documentation for the specified modules. Handles environment setup and arguments.
            - input: output_dir: Path, target directory; modules: Sequence[str] | str, modules to document; all_submodules: bool, recursion flag
            - output: None
            - calls:
                - `_normalize_modules()`: Normalizes module input. [`src/usereq/pdoc_utils.py`, 12-16]
                    - description: Converts a single string module name or an iterable of names into a list of strings.
                    - input: modules: str | Iterable[str]
                    - output: list[str], list of module names
                - `_run_pdoc()`: Executes the pdoc command. [`src/usereq/pdoc_utils.py`, 19-28]
                    - description: Wrapper around `subprocess.run` to execute pdoc with the constructed command and environment.
                    - input: command: list[str]; env: dict; cwd: Path
                    - output: subprocess.CompletedProcess

## Standalone File Commands Flow
- **Token Counting (`--files-tokens`)**
    - `src/usereq/cli.py`
        - `run_files_tokens()`: Counts tokens and characters for a list of files. [`src/usereq/cli.py`, 2048-2064]
            - description: Reads each file, computes token/character metrics via TokenCounter, formats a pack summary, and prints it to stdout. Skips non-existent files with a stderr warning.
            - input: files: list[str], file paths
            - output: None (prints to stdout)
            - calls:
                - `count_files_metrics()`: Computes per-file metrics. [`src/usereq/token_counter.py`, 45-70]
                    - description: Iterates over file paths, reads content, counts tokens and characters for each file. Non-existent files produce an error entry.
                    - input: file_paths: list; encoding_name: str
                    - output: list[dict], per-file metrics with keys: file, tokens, chars (or error)
                    - calls:
                        - `count_file_metrics()`: Computes metrics for a single file content. [`src/usereq/token_counter.py`, 32-43]
                            - input: content: str; filename: str; encoding_name: str
                            - output: dict with keys: file, tokens, chars
                            - calls:
                                - `TokenCounter.count_tokens()`: Counts tokens via tiktoken. [`src/usereq/token_counter.py`, 19-25]
                                    - input: content: str
                                    - output: int, token count
                                - `TokenCounter.count_chars()`: Counts characters. [`src/usereq/token_counter.py`, 27-30]
                                    - input: content: str
                                    - output: int, character count
                - `format_pack_summary()`: Formats metrics into a summary table. [`src/usereq/token_counter.py`, 73-106]
                    - description: Produces a "Pack Summary" table with per-file and total token/character counts.
                    - input: results: list[dict]
                    - output: str, formatted summary

- **Markdown Reference Generation (`--files-references`)**
    - `src/usereq/cli.py`
        - `run_files_references()`: Generates markdown reference from source files. [`src/usereq/cli.py`, 2066-2072]
            - description: Delegates to generate_markdown() and prints the result to stdout.
            - input: files: list[str], file paths
            - output: None (prints to stdout)
            - calls:
                - `generate_markdown()`: Produces markdown from source files. [`src/usereq/generate_markdown.py`, 55-108]
                    - description: Analyzes each file with SourceAnalyzer, formats results as markdown via format_markdown(), joins multiple files with `---` separators. Skips non-existent or unsupported files with stderr warnings.
                    - input: filepaths: list[str]
                    - output: str, concatenated markdown
                    - calls:
                        - `detect_language()`: Detects language from file extension. [`src/usereq/generate_markdown.py`, 49-53]
                            - input: filepath: str
                            - output: str | None, language name
                        - `SourceAnalyzer.analyze()`: Parses source into structural elements. [`src/usereq/source_analyzer.py`, 690-836]
                            - input: filepath: str; language: str
                            - output: list[SourceElement], parsed elements
                        - `SourceAnalyzer.enrich()`: Enriches parsed elements with metadata. [`src/usereq/source_analyzer.py`, 979-995]
                            - input: elements: list; language: str; source_code: str
                            - output: list, enriched elements
                        - `format_markdown()`: Formats elements as markdown. [`src/usereq/source_analyzer.py`, 1642-2015]
                            - input: elements: list; source_code: str; filepath: str; language: str
                            - output: str, markdown representation

- **Source Compression (`--files-compress`)**
    - `src/usereq/cli.py`
        - `run_files_compress()`: Compresses source files. [`src/usereq/cli.py`, 2074-2080]
            - description: Delegates to compress_files() and prints the result to stdout.
            - input: files: list[str], file paths
            - output: None (prints to stdout)
            - calls:
                - `compress_files()`: Compresses multiple source files. [`src/usereq/compress_files.py`, 24-72]
                    - description: For each valid file, detects language, compresses source, and prepends an `@@@ path | lang` header. Skips non-existent or unsupported files.
                    - input: filepaths: list[str]; include_line_numbers: bool
                    - output: str, compressed output
                    - calls:
                        - `compress_file()`: Compresses a single source file. [`src/usereq/compress.py`, 320-343]
                            - input: filepath: str; language: str | None; include_line_numbers: bool
                            - output: str, compressed source
                            - calls:
                                - `detect_language()`: Detects language from extension. [`src/usereq/compress.py`, 52-55]
                                    - input: filepath: str
                                    - output: str | None
                                - `compress_source()`: Core compression logic. [`src/usereq/compress.py`, 148-318]
                                    - description: Removes comments (single-line, multi-line, docstrings), blank lines, and trailing whitespace. Preserves indentation for Python/Haskell/Elixir. Optionally adds `Lnn>` line number prefixes.
                                    - input: source: str; language: str; include_line_numbers: bool
                                    - output: str, compressed source

## Project-Scoped Commands Flow
- **Project Reference Generation (`--references`)**
    - `src/usereq/cli.py`
        - `run_references()`: Generates markdown reference for all project sources. [`src/usereq/cli.py`, 2082-2092]
            - description: Resolves project base and src-dirs, collects all source files with supported extensions (excluding ignored directories), then delegates to run_files_references().
            - input: args: Namespace, parsed CLI arguments
            - output: None
            - calls:
                - `_resolve_project_src_dirs()`: Resolves project base path and source directories. [`src/usereq/cli.py`, 2106-2138]
                    - description: Determines project base from --base/--here, loads src-dir from CLI args or .req/config.json.
                    - input: args: Namespace
                    - output: tuple[Path, list[str]], (project_base, src_dirs)
                - `_collect_source_files()`: Collects source files from directories. [`src/usereq/cli.py`, 2009-2029]
                    - description: Walks each src-dir recursively, skipping EXCLUDED_DIRS, collecting files whose extension is in SUPPORTED_EXTENSIONS. Returns sorted list of absolute paths.
                    - input: src_dirs: list[str]; project_base: Path
                    - output: list[str], sorted file paths
                - `run_files_references()`: Generates markdown (see above).

- **Project Source Compression (`--compress`)**
    - `src/usereq/cli.py`
        - `run_compress_cmd()`: Compresses all project sources. [`src/usereq/cli.py`, 2094-2104]
            - description: Resolves project base and src-dirs, collects all source files, then delegates to run_files_compress().
            - input: args: Namespace, parsed CLI arguments
            - output: None
            - calls:
                - `_resolve_project_src_dirs()`: Resolves project context (see above).
                - `_collect_source_files()`: Collects source files (see above).
                - `run_files_compress()`: Compresses files (see above).

## Source Analyzer Module
- **Multi-Language Source Code Analysis**
    - `src/usereq/source_analyzer.py`
        - `build_language_specs()`: Builds language specification registry. [`src/usereq/source_analyzer.py`, 117-667]
            - description: Returns a dictionary mapping 20+ language names (and aliases) to LanguageSpec dataclass instances. Each spec defines comment syntax, string delimiters, block start/end patterns, and keyword patterns.
            - input: None
            - output: dict[str, LanguageSpec], language specifications
        - `SourceAnalyzer`: Main source analysis class. [`src/usereq/source_analyzer.py`, 669-1639]
            - `__init__()`: Initializes specs via build_language_specs(). [`src/usereq/source_analyzer.py`, 677-678]
            - `get_supported_languages()`: Returns list of supported language names. [`src/usereq/source_analyzer.py`, 680-688]
            - `analyze()`: Parses a source file into SourceElement list. [`src/usereq/source_analyzer.py`, 690-836]
                - description: Reads file, tracks string/comment context, identifies functions, classes, structs, enums, interfaces, modules, traits, macros, constants, imports via regex patterns.
                - input: filepath: str; language: str
                - output: list[SourceElement]
            - `enrich()`: Enriches elements with signatures, hierarchy, visibility, inheritance. [`src/usereq/source_analyzer.py`, 979-995]
                - input: elements: list; language: str; source_code: str
                - output: list, enriched elements
            - `_in_string_context()`: Checks if position is inside a string. [`src/usereq/source_analyzer.py`, 838-865]
            - `_find_comment()`: Finds comment start position in a line. [`src/usereq/source_analyzer.py`, 867-899]
            - `_find_block_end()`: Finds the end of a block (brace/indent). [`src/usereq/source_analyzer.py`, 901-977]
            - `_clean_names()`: Cleans element names from surrounding syntax. [`src/usereq/source_analyzer.py`, 997-1024]
            - `_extract_signatures()`: Extracts full signatures from source. [`src/usereq/source_analyzer.py`, 1026-1039]
            - `_detect_hierarchy()`: Detects parent-child nesting. [`src/usereq/source_analyzer.py`, 1041-1075]
            - `_extract_visibility()`: Extracts public/private/protected visibility. [`src/usereq/source_analyzer.py`, 1077-1087]
            - `_extract_inheritance()`: Extracts inheritance/implementation info. [`src/usereq/source_analyzer.py`, 1134-1639]
        - `format_output()`: Formats elements as structured text. [`src/usereq/source_analyzer.py`, 1642-1700]
            - input: elements: list; source_code: str; filepath: str; language: str
            - output: str
        - `format_markdown()`: Formats elements as markdown with headers and tables. [`src/usereq/source_analyzer.py`, 1703-2015]
            - input: elements: list; source_code: str; filepath: str; language: str
            - output: str, markdown representation

## Compress Module
- **Source Code Compression**
    - `src/usereq/compress.py`
        - `compress_source()`: Core compression function. [`src/usereq/compress.py`, 148-318]
            - description: Removes single-line comments, multi-line comments, docstrings, blank lines, trailing whitespace. Preserves indentation for indent-significant languages (Python, Haskell, Elixir). Preserves shebang lines and comments inside strings.
            - input: source: str; language: str; include_line_numbers: bool (default True)
            - output: str, compressed source
        - `compress_file()`: Compresses a file by path. [`src/usereq/compress.py`, 320-343]
            - input: filepath: str; language: str | None; include_line_numbers: bool
            - output: str, compressed source
        - `detect_language()`: Detects language from file extension. [`src/usereq/compress.py`, 52-55]
            - input: filepath: str
            - output: str | None

## Compress Files Module
- **Multi-File Compression**
    - `src/usereq/compress_files.py`
        - `compress_files()`: Compresses multiple files with headers. [`src/usereq/compress_files.py`, 24-72]
            - description: Iterates over file paths, detects language, compresses each, and prepends `@@@ path | lang` header. Skips invalid files with stderr warning.
            - input: filepaths: list[str]; include_line_numbers: bool (default True)
            - output: str, concatenated compressed output

## CLI Command Dispatch Helpers
- **Command Classification and Routing**
    - `src/usereq/cli.py`
        - `_is_standalone_command()`: Checks if a standalone command is requested. [`src/usereq/cli.py`, 2031-2038]
            - description: Returns True if --files-tokens, --files-references, or --files-compress is set.
            - input: args: Namespace
            - output: bool
        - `_is_project_scan_command()`: Checks if a project-scoped command is requested. [`src/usereq/cli.py`, 2040-2046]
            - description: Returns True if --references or --compress is set.
            - input: args: Namespace
            - output: bool
        - `EXCLUDED_DIRS`: Hardcoded frozenset of 16 directory names to skip. [`src/usereq/cli.py`, 1992-1999]
        - `SUPPORTED_EXTENSIONS`: Hardcoded frozenset of 20 file extensions. [`src/usereq/cli.py`, 2001-2007]
